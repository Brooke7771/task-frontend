<!DOCTYPE html>
<html lang="uk" class="dark">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º—ñ–Ω –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth-guard.js"></script>
    <style>
        .btn-sm { padding: 5px 10px; font-size: 0.85em; margin-left: 5px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .badge-active { background: rgba(0, 255, 0, 0.15); color: #4ade80; border: 1px solid #4ade80; }
        .badge-pending { background: rgba(255, 165, 0, 0.15); color: #fbbf24; border: 1px solid #fbbf24; }
        .perm-label { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .perm-label:hover { background: rgba(255,255,255,0.05); }
        .section-title { font-size: 0.9em; text-transform: uppercase; color: var(--color-primary); margin: 10px 0 5px 0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-main">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <h1>üëë –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h1>
                <a href="index.html" class="btn" style="width:auto">–í –¥–æ–¥–∞—Ç–æ–∫ -></a>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid #555;">
                            <th style="padding:10px;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th style="padding:10px;">–¢–µ–ª–µ–≥—Ä–∞–º</th>
                            <th style="padding:10px;">–ó–∞–ø–∏—Ç</th>
                            <th style="padding:10px;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="padding:10px;">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="permissionsModal" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10000; border:1px solid var(--color-primary); width:90%; max-width:500px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);">
        <h2 style="margin-top:0">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É üîê</h2>
        <p id="modalUser" style="color: var(--color-text-light); margin-bottom: 15px;"></p>
        
        <form id="permForm">
            <div style="max-height: 400px; overflow-y: auto; padding-right:5px;">
                
                <div class="section-title">üìÑ –î–æ—Å—Ç—É–ø –¥–æ —Å—Ç–æ—Ä—ñ–Ω–æ–∫</div>
                <div style="border: 1px solid var(--color-border); border-radius: 8px; margin-bottom:15px;">
                    <label class="perm-label"><input type="checkbox" name="pages" value="index.html"> üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ó–∞–≤–¥–∞–Ω—å</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="task-list.html"> üìã –°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="schedule.html"> üìÖ –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ü–æ—Å—Ç—ñ–≤</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="schedule-list.html"> üïí –°–ø–∏—Å–æ–∫ –ü–æ—Å—Ç—ñ–≤</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="ads.html"> üì¢ –†–µ–∫–ª–∞–º–∞</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="chat.html"> ü§ñ AI –ß–∞—Ç</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="history.html"> üìú –Ü—Å—Ç–æ—Ä—ñ—è</label>
                    <label class="perm-label"><input type="checkbox" name="pages" value="settings.html"> ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</label>
                </div>

                <div class="section-title">üì¢ –î–æ—Å—Ç—É–ø –¥–æ –∫–∞–Ω–∞–ª—ñ–≤</div>
                <div id="channelsContainer" style="border: 1px solid var(--color-border); border-radius: 8px;">
                    <p style="padding:10px; color:#aaa;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–Ω–∞–ª—ñ–≤...</p>
                </div>

            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { backendUrl, getChannels } from './api.js';

        let currentUserId = null;
        let allChannels = [];

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞–Ω–∞–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        async function loadAllChannels() {
            try { allChannels = await getChannels(); } catch(e){ console.error(e); }
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';
            try {
                const res = await fetch(`${backendUrl}/api/admin/users`);
                const users = await res.json();
                
                tbody.innerHTML = users.map(u => {
                    let requested = [];
                    try { requested = JSON.parse(u.requested_features || "[]"); } catch(e){}
                    let allowedPages = [];
                    try { allowedPages = JSON.parse(u.allowed_pages || "[]"); } catch(e){}
                    let allowedChannels = [];
                    try { allowedChannels = JSON.parse(u.allowed_channels || "[]"); } catch(e){}

                    const statusBadge = u.is_approved ? `<span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–∏–π</span>` : `<span class="badge badge-pending">–û—á—ñ–∫—É—î</span>`;
                    
                    // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–∞–Ω—ñ –≤ –∫–Ω–æ–ø–∫—É
                    const dataStr = encodeURIComponent(JSON.stringify({ 
                        pages: allowedPages, 
                        channels: allowedChannels,
                        req: requested,
                        req_ch: u.channel_id
                    }));

                    return `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                        <td style="padding:12px;"><strong>${u.username}</strong></td>
                        <td style="padding:12px;">${u.telegram_username || '-'}<br><small>${u.email || ''}</small></td>
                        <td style="padding:12px; font-size:0.9em; color:var(--color-primary);">${u.channel_name || '-'}<br>${requested.join(", ")}</td>
                        <td style="padding:12px;">${statusBadge}</td>
                        <td style="padding:12px;">
                            <button onclick="openPermissionsModal(${u.id}, '${u.username}', '${dataStr}')" class="btn btn-warning btn-sm">‚öôÔ∏è –ü—Ä–∞–≤–∞</button>
                            <button onclick="deleteUser(${u.id})" class="btn btn-danger btn-sm">üóë</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="5">–ü–æ–º–∏–ª–∫–∞</td></tr>'; }
        }

        window.openPermissionsModal = (id, name, dataStr) => {
            currentUserId = id;
            document.getElementById('modalUser').innerHTML = `–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è: <strong>${name}</strong>`;
            const data = JSON.parse(decodeURIComponent(dataStr));

            // 1. –°—Ç–æ—Ä—ñ–Ω–∫–∏
            document.querySelectorAll('input[name="pages"]').forEach(cb => {
                cb.checked = data.pages.includes(cb.value);
            });

            // 2. –ö–∞–Ω–∞–ª–∏ (–†–µ–Ω–¥–µ—Ä–∏–º–æ —Å–ø–∏—Å–æ–∫)
            const chContainer = document.getElementById('channelsContainer');
            if (allChannels.length === 0) {
                chContainer.innerHTML = '<p style="padding:10px;">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞–Ω–∞–ª—ñ–≤. –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ —ó—Ö —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö.</p>';
            } else {
                chContainer.innerHTML = allChannels.map(ch => `
                    <label class="perm-label">
                        <input type="checkbox" name="channels" value="${ch.telegram_id}" ${data.channels.includes(String(ch.telegram_id)) ? 'checked' : ''}>
                        <span>${ch.title} <small>(${ch.telegram_id})</small></span>
                    </label>
                `).join('');
                
                // –Ø–∫—â–æ —É —é–∑–µ—Ä–∞ –±—É–≤ –∑–∞–ø–∏—Ç –Ω–∞ –∫–∞–Ω–∞–ª, —ñ —Ü–µ–π –∫–∞–Ω–∞–ª —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ –≤ —Å–∏—Å—Ç–µ–º—É - –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É
                if (data.req_ch && !allChannels.find(c => String(c.telegram_id) === String(data.req_ch))) {
                    chContainer.innerHTML += `<div style="padding:10px; color:orange; border-top:1px solid #444;">‚ö†Ô∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ—Å–∏–≤ –∫–∞–Ω–∞–ª ID: ${data.req_ch}. –î–æ–¥–∞–π—Ç–µ –π–æ–≥–æ —Å–ø–æ—á–∞—Ç–∫—É –≤ —Å–∏—Å—Ç–µ–º—É (–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -> –ö–∞–Ω–∞–ª–∏), —â–æ–± –≤—ñ–Ω –∑'—è–≤–∏–≤—Å—è —Ç—É—Ç.</div>`;
                }
            }

            document.getElementById('permissionsModal').style.display = 'block';
        };

        window.closeModal = () => document.getElementById('permissionsModal').style.display = 'none';

        document.getElementById('permForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pages = [];
            document.querySelectorAll('input[name="pages"]:checked').forEach(cb => pages.push(cb.value));
            const channels = [];
            document.querySelectorAll('input[name="channels"]:checked').forEach(cb => channels.push(cb.value));

            // –ë–∞–∑–æ–≤—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            if(!pages.includes('index.html')) pages.push('index.html');

            await fetch(`${backendUrl}/api/admin/users/${currentUserId}/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ is_approved: true, allowed_pages: pages, allowed_channels: channels })
            });
            closeModal();
            loadUsers();
        });

        window.deleteUser = async (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) {
                await fetch(`${backendUrl}/api/admin/users/${id}/delete`, { method: 'POST' });
                loadUsers();
            }
        };

        // –°—Ç–∞—Ä—Ç
        loadAllChannels().then(loadUsers);
    </script>
</body>
</html>