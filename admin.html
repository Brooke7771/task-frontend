<!DOCTYPE html>
<html lang="uk" class="dark">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º—ñ–Ω –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth-guard.js"></script>
</head>
<body>
    <div class="container-main">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h1>üëë –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h1>
                <a href="index.html" class="btn" style="width:auto">–í –¥–æ–¥–∞—Ç–æ–∫ -></a>
            </div>
            
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid #555;">
                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th>–¢–µ–ª–µ–≥—Ä–∞–º/–ü–æ—à—Ç–∞</th>
                            <th>–ö–∞–Ω–∞–ª</th>
                            <th>–ó–∞–ø–∏—Ç —Ñ—É–Ω–∫—Ü—ñ–π</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="permissionsModal" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; border:2px solid var(--color-primary); width:90%; max-width:400px;">
        <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É</h3>
        <p id="modalUser"></p>
        <form id="permForm">
            <label><input type="checkbox" value="index.html"> –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ó–∞–≤–¥–∞–Ω—å</label><br>
            <label><input type="checkbox" value="schedule.html"> –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ü–æ—Å—Ç—ñ–≤</label><br>
            <label><input type="checkbox" value="ads.html"> –†–µ–∫–ª–∞–º–∞</label><br>
            <label><input type="checkbox" value="chat.html"> AI –ß–∞—Ç</label><br>
            <label><input type="checkbox" value="settings.html"> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</label><br>
            <br>
            <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏</button>
            <button type="button" class="btn btn-danger" onclick="closeModal()" style="margin-top:10px">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
    </div>

    <script type="module">
        import { backendUrl } from './api.js';

        let currentUserId = null;

        async function loadUsers() {
            const res = await fetch(`${backendUrl}/api/admin/users`);
            const users = await res.json();
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.map(u => {
                const features = JSON.parse(u.requested_features || "[]").join(", ");
                const status = u.is_approved ? '<span style="color:lime">–ê–∫—Ç–∏–≤–Ω–∏–π</span>' : '<span style="color:orange">–û—á—ñ–∫—É—î</span>';
                
                return `
                <tr style="border-bottom:1px solid #333;">
                    <td style="padding:10px;">${u.username}</td>
                    <td style="padding:10px;">${u.telegram_username}<br><small>${u.email}</small></td>
                    <td style="padding:10px;">${u.channel_name}<br><small>${u.channel_id}</small></td>
                    <td style="padding:10px;">${features}</td>
                    <td style="padding:10px;">${status}</td>
                    <td style="padding:10px;">
                        ${!u.is_approved ? `<button onclick="window.openApprove(${u.id}, '${u.username}')" class="btn btn-success btn-sm">‚úÖ</button>` : ''}
                        <button onclick="window.deleteUser(${u.id})" class="btn btn-danger btn-sm">üóë</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.openApprove = (id, name) => {
            currentUserId = id;
            document.getElementById('modalUser').innerText = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${name}`;
            document.getElementById('permissionsModal').style.display = 'block';
        };

        window.closeModal = () => {
            document.getElementById('permissionsModal').style.display = 'none';
        };

        document.getElementById('permForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const allowed = [];
            e.target.querySelectorAll('input:checked').forEach(cb => allowed.push(cb.value));
            
            await fetch(`${backendUrl}/api/admin/users/${currentUserId}/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ is_approved: true, allowed_pages: allowed })
            });
            closeModal();
            loadUsers();
        });

        window.deleteUser = async (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?")) {
                await fetch(`${backendUrl}/api/admin/users/${id}/delete`, { method: 'POST' });
                loadUsers();
            }
        };

        loadUsers();
    </script>
</body>
</html>