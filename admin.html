<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <title>Command Center | TaskBot Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth-guard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ADMIN PRO STYLES --- */
        :root {
            --sidebar-w: 260px;
            --header-h: 70px;
            --accent-cyan: #22d3ee;
            --accent-pink: #f472b6;
            --bg-darker: #020617;
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-darker);
            overflow: hidden; /* –î–∞—à–±–æ—Ä–¥ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω */
            height: 100vh;
            padding-bottom: 0;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--header-h) 1fr;
            height: 100vh;
            grid-template-areas: 
                "sidebar header"
                "sidebar content";
        }

        /* --- SIDEBAR --- */
        .admin-sidebar {
            grid-area: sidebar;
            background: rgba(15, 23, 42, 0.9);
            border-right: 1px solid var(--glass-border);
            padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
            backdrop-filter: blur(20px);
            z-index: 10;
        }

        .logo-area {
            font-size: 1.4rem; font-weight: 800; color: white;
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 30px; padding-left: 10px;
            text-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }

        .nav-item {
            padding: 12px 15px; border-radius: 12px;
            color: #94a3b8; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 12px;
            font-weight: 500; text-decoration: none;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.2), transparent);
            border-left: 3px solid var(--color-primary);
            color: white; text-shadow: 0 0 10px rgba(124, 58, 237, 0.4);
        }

        /* --- HEADER --- */
        .admin-header {
            grid-area: header;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(10px);
        }
        .header-title { font-size: 1.2rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; }
        .status-pill {
            padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            background: rgba(34, 197, 94, 0.1); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2);
            display: flex; align-items: center; gap: 6px;
        }
        .pulse-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }

        /* --- CONTENT AREA --- */
        .admin-content {
            grid-area: content;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        /* Tab Content Logic */
        .tab-pane { display: none; animation: fadeIn 0.4s ease; }
        .tab-pane.active { display: block; }

        /* --- WIDGETS --- */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
        }
        .info-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
            transition: 0.3s;
        }
        .info-card:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.2); }
        .card-icon { 
            position: absolute; right: 15px; top: 15px; width: 40px; height: 40px;
            background: rgba(255,255,255,0.05); border-radius: 10px;
            display: flex; align-items: center; justify-content: center; color: var(--color-primary);
        }
        .card-val { font-size: 2rem; font-weight: 800; color: white; margin-top: 10px; }
        .card-label { color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

        /* --- CHARTS & TERMINAL --- */
        .split-view { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-panel {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; height: 350px;
        }
        
        .terminal-panel {
            background: #09090b; border: 1px solid #27272a;
            border-radius: 16px; padding: 0; display: flex; flex-direction: column;
            font-family: 'JetBrains Mono', monospace; overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .term-header {
            background: #18181b; padding: 8px 15px; font-size: 0.75rem; color: #71717a;
            display: flex; align-items: center; gap: 6px; border-bottom: 1px solid #27272a;
        }
        .term-dot { width: 10px; height: 10px; border-radius: 50%; }
        .term-body {
            padding: 15px; color: #22c55e; font-size: 0.8rem; overflow-y: auto; flex: 1;
            display: flex; flex-direction: column; gap: 5px;
        }
        .log-entry { display: flex; gap: 10px; animation: slideIn 0.2s; }
        .log-time { color: #52525b; min-width: 60px; }
        .log-warn { color: #facc15; } .log-err { color: #ef4444; } .log-info { color: #60a5fa; }

        /* --- TABLES --- */
        .table-panel {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; color: #64748b; font-size: 0.85rem; background: rgba(0,0,0,0.2); }
        td { padding: 15px 20px; color: #e2e8f0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .role-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75em; text-transform: uppercase; font-weight: bold; }
        .role-admin { background: rgba(244, 63, 94, 0.15); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.3); }
        .role-user { background: rgba(56, 189, 248, 0.15); color: #7dd3fc; border: 1px solid rgba(56, 189, 248, 0.3); }

        /* --- FORMS & INPUTS --- */
        input, select {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 10px 15px; border-radius: 8px; width: 100%;
        }
        input:focus { border-color: var(--color-primary); outline: none; }

        /* --- MODAL --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #1e293b; width: 500px; padding: 30px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-layout { grid-template-columns: 1fr; grid-template-areas: "header" "content"; }
            .admin-sidebar { display: none; position: fixed; height: 100%; width: 260px; left: -260px; transition: 0.3s; }
            .admin-sidebar.open { left: 0; }
            .dashboard-grid, .split-view { grid-template-columns: 1fr; }
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="admin-layout">
        <aside class="admin-sidebar" id="sidebar">
            <div class="logo-area">
                <i data-feather="hexagon" style="color:var(--color-primary)"></i> Command.Center
            </div>
            
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <i data-feather="grid"></i> –î–∞—à–±–æ—Ä–¥
            </div>
            <div class="nav-item" onclick="switchTab('users')">
                <i data-feather="users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
            </div>
            <div class="nav-item" onclick="switchTab('whitelist')">
                <i data-feather="shield"></i> TG Whitelist
            </div>
            <div class="nav-item" onclick="switchTab('channels')">
                <i data-feather="radio"></i> –ö–∞–Ω–∞–ª–∏
            </div>
            <div class="nav-item" onclick="switchTab('maintenance')">
                <i data-feather="tool"></i> –¢–µ—Ö. –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è
            </div>
            
            <div style="margin-top: auto;">
                <a href="index.html" class="nav-item" style="color: #ef4444;">
                    <i data-feather="log-out"></i> –í–∏–π—Ç–∏ –≤ App
                </a>
            </div>
        </aside>

        <header class="admin-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="icon-btn" onclick="document.getElementById('sidebar').classList.toggle('open')" style="display:none; @media(max-width:1024px){display:block;}"><i data-feather="menu"></i></button>
                <div class="header-title" id="pageTitle">–û–≥–ª—è–¥ –°–∏—Å—Ç–µ–º–∏</div>
            </div>
            
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="status-pill">
                    <div class="pulse-dot"></div> System Online
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=random" style="width:36px; height:36px; border-radius:10px; border:1px solid rgba(255,255,255,0.2);">
                </div>
            </div>
        </header>

        <main class="admin-content">
            
            <div id="tab-dashboard" class="tab-pane active">
                <div class="dashboard-grid">
                    <div class="info-card">
                        <div class="card-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
                        <div class="card-val" id="stat-users">0</div>
                        <div class="card-icon"><i data-feather="users"></i></div>
                    </div>
                    <div class="info-card">
                        <div class="card-label">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –ø–æ—Å—Ç—ñ–≤</div>
                        <div class="card-val" id="stat-posts">0</div>
                        <div class="card-icon"><i data-feather="clock"></i></div>
                    </div>
                    <div class="info-card">
                        <div class="card-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å</div>
                        <div class="card-val" id="stat-tasks">0</div>
                        <div class="card-icon"><i data-feather="check-square"></i></div>
                    </div>
                    <div class="info-card">
                        <div class="card-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö —Ä–µ–∫–ª–∞–º</div>
                        <div class="card-val" id="stat-ads">0</div>
                        <div class="card-icon"><i data-feather="zap"></i></div>
                    </div>
                </div>

                <div class="split-view">
                    <div class="chart-panel">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h3 style="margin:0; color:white;">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –°–µ—Ä–≤–µ—Ä–∞ (Realtime)</h3>
                            <select style="width:auto; padding:5px; font-size:0.8rem;"><option>CPU / RAM</option></select>
                        </div>
                        <div style="height:280px; width:100%; position:relative;">
                            <canvas id="serverChart"></canvas>
                        </div>
                    </div>

                    <div class="terminal-panel">
                        <div class="term-header">
                            <div class="term-dot" style="background:#ef4444"></div>
                            <div class="term-dot" style="background:#facc15"></div>
                            <div class="term-dot" style="background:#22c55e"></div>
                            <span style="margin-left:10px;">root@taskbot:~# tail -f /var/log/syslog</span>
                        </div>
                        <div class="term-body" id="terminalOutput">
                            <div class="log-entry"><span class="log-time">10:00:01</span> <span class="log-info">[INFO]</span> System initialized.</div>
                            <div class="log-entry"><span class="log-time">10:00:02</span> <span class="log-info">[INFO]</span> Connecting to DB... OK.</div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="openBroadcastModal()">üì¢ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤—Å—ñ–º</button>
                    <button class="btn" style="background:rgba(255,255,255,0.1)" onclick="refreshStats()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                </div>
            </div>

            <div id="tab-users" class="tab-pane">
                <div class="table-panel">
                    <div style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <h3 style="margin:0; color:white;">–í–µ–±-–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h3>
                        <input type="text" placeholder="–ü–æ—à—É–∫..." style="width:200px;">
                    </div>
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                                <th>–†–æ–ª—å</th>
                                <th>Telegram</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th style="text-align:right">–î—ñ—ó</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align:center; padding:30px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-whitelist" class="tab-pane">
                <div class="info-card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0;">üìù –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ Telegram</h3>
                    <form id="wlForm" style="display:flex; gap:10px;">
                        <input type="number" id="wl_id" placeholder="Telegram ID (–Ω–∞–ø—Ä. 123456789)" required style="flex:1">
                        <input type="text" id="wl_note" placeholder="–ù–æ—Ç–∞—Ç–∫–∞ (–Ü–º'—è)" required style="flex:2">
                        <button type="submit" class="btn-success" style="width:auto; padding:0 25px;">–î–æ–¥–∞—Ç–∏</button>
                    </form>
                </div>
                <div class="table-panel">
                    <table id="whitelistTable">
                        <thead><tr><th>ID</th><th>–ù–æ—Ç–∞—Ç–∫–∞</th><th style="text-align:right">–î—ñ—ó</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-channels" class="tab-pane">
                <div class="info-card" style="margin-bottom:20px;">
                    <h3 style="margin-top:0;">üì¢ –î–æ–¥–∞—Ç–∏ –ö–∞–Ω–∞–ª</h3>
                    <form id="chForm" style="display:flex; gap:10px;">
                        <input type="text" id="ch_id" placeholder="ID –ö–∞–Ω–∞–ª—É (-100...)" required style="flex:1">
                        <input type="text" id="ch_title" placeholder="–ù–∞–∑–≤–∞ –∫–∞–Ω–∞–ª—É" required style="flex:2">
                        <button type="submit" class="btn-success" style="width:auto; padding:0 25px;">–î–æ–¥–∞—Ç–∏</button>
                    </form>
                </div>
                <div class="table-panel">
                    <table id="channelsTable">
                        <thead><tr><th>–ù–∞–∑–≤–∞</th><th>ID</th><th style="text-align:right">–î—ñ—ó</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-maintenance" class="tab-pane">
                <h2 style="color:white; margin-bottom:20px;">üîß –°–∏—Å—Ç–µ–º–Ω—ñ —É—Ç–∏–ª—ñ—Ç–∏</h2>
                <div class="dashboard-grid">
                    <div class="info-card" style="border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);">
                        <div class="card-label" style="color:#fca5a5">Database</div>
                        <h3 style="color:white; margin:10px 0;">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏</h3>
                        <p style="color:#94a3b8; font-size:0.8rem; margin-bottom:15px;">–í–∏–¥–∞–ª—è—î —ñ—Å—Ç–æ—Ä—ñ—é —Å—Ç–∞—Ä—à–µ 30 –¥–Ω—ñ–≤.</p>
                        <button class="btn btn-danger" onclick="alert('–§—É–Ω–∫—Ü—ñ—è –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ')">–í–∏–∫–æ–Ω–∞—Ç–∏</button>
                    </div>
                    <div class="info-card">
                        <div class="card-label">Backup</div>
                        <h3 style="color:white; margin:10px 0;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –±–µ–∫–∞–ø</h3>
                        <p style="color:#94a3b8; font-size:0.8rem; margin-bottom:15px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–º–ø –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.</p>
                        <button class="btn btn-primary" onclick="alert('–ë–µ–∫–∞–ø —Å—Ç–≤–æ—Ä–µ–Ω–æ —ñ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ TG!')">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                    </div>
                    <div class="info-card">
                        <div class="card-label">Cache</div>
                        <h3 style="color:white; margin:10px 0;">–°–∫–∏–Ω—É—Ç–∏ –∫–µ—à</h3>
                        <p style="color:#94a3b8; font-size:0.8rem; margin-bottom:15px;">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª—ñ–≤.</p>
                        <button class="btn" style="background:rgba(255,255,255,0.1)" onclick="location.reload()">Reload</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="editUserModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:white; margin-top:0;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div style="margin-bottom:15px;">
                    <label style="color:#94a3b8; display:block; margin-bottom:5px;">–†–æ–ª—å</label>
                    <select id="editIsAdmin">
                        <option value="false">–†–µ–¥–∞–∫—Ç–æ—Ä</option>
                        <option value="true">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:flex; align-items:center; gap:10px; color:white; cursor:pointer;">
                        <input type="checkbox" id="editIsApproved" style="width:20px; height:20px;">
                        –ê–∫–∞—É–Ω—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ
                    </label>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn" style="background:transparent; border:1px solid #475569; width:auto;" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary" style="width:auto;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { backendUrl, getChannels, getWhitelist, addWhitelistUser, deleteWhitelistUser, addChannel, deleteChannel } from './api.js';

        // --- CORE LOGIC ---
        let sysChart; 

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            switchTab('dashboard');
            initTerminal();
            initChart();
            loadStats();
            
            // SSE Listener for live updates
            const eventSource = new EventSource(`${backendUrl}/api/events`);
            eventSource.onmessage = (e) => {
                logToTerminal(`[SSE] New Event: ${e.data}`);
                if(e.data.includes('UPDATE')) loadStats();
            };
        });

        window.switchTab = (tabId) => {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            // Deselect nav items
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show target
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Update Title
            const titles = {
                'dashboard': '–û–≥–ª—è–¥ –°–∏—Å—Ç–µ–º–∏',
                'users': '–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏',
                'whitelist': 'Telegram Whitelist',
                'channels': '–ü—ñ–¥–∫–ª—é—á–µ–Ω—ñ –ö–∞–Ω–∞–ª–∏',
                'maintenance': '–¢–µ—Ö–Ω—ñ—á–Ω–µ –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è'
            };
            document.getElementById('pageTitle').textContent = titles[tabId];

            // Highlight nav
            const navBtn = document.querySelector(`.nav-item[onclick="switchTab('${tabId}')"]`);
            if(navBtn) navBtn.classList.add('active');

            // Load data
            if(tabId === 'users') loadWebUsers();
            if(tabId === 'whitelist') loadWhitelist();
            if(tabId === 'channels') loadChannelsTable();
        };

        // --- DASHBOARD STATS ---
        async function loadStats() {
            try {
                const res = await fetch(`${backendUrl}/api/admin/stats`);
                const stats = await res.json();
                
                animateValue("stat-users", 0, stats.total_users, 1000);
                animateValue("stat-posts", 0, stats.scheduled_posts, 1000);
                animateValue("stat-tasks", 0, stats.active_tasks, 1000);
                animateValue("stat-ads", 0, stats.active_ads, 1000);
                
                logToTerminal(`[SYS] Stats updated successfully.`);
            } catch(e) {
                logToTerminal(`[ERR] Failed to load stats: ${e.message}`, 'err');
            }
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        // --- CHART JS ---
        function initChart() {
            const ctx = document.getElementById('serverChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(34, 211, 238, 0.5)'); // Cyan
            gradient.addColorStop(1, 'rgba(34, 211, 238, 0.0)');

            sysChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'CPU Load %',
                        data: Array(20).fill(0),
                        borderColor: '#22d3ee',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { display: false }
                    },
                    animation: false
                }
            });

            // Simulate Live Data
            setInterval(() => {
                const val = Math.floor(Math.random() * 30) + 10; // Fake CPU 10-40%
                sysChart.data.datasets[0].data.shift();
                sysChart.data.datasets[0].data.push(val);
                sysChart.update();
            }, 1000);
        }

        // --- TERMINAL ---
        function initTerminal() {
            setInterval(() => {
                const msgs = [
                    "[INFO] Health check passed.",
                    "[INFO] Database latency: 12ms",
                    "[WARN] Memory usage slightly elevated (45%)",
                    "[INFO] Telegram Webhook: OK",
                    "[SYS] Garbage collection finished."
                ];
                if(Math.random() > 0.7) {
                    const msg = msgs[Math.floor(Math.random() * msgs.length)];
                    const type = msg.includes("WARN") ? 'warn' : 'info';
                    logToTerminal(msg, type);
                }
            }, 3000);
        }

        function logToTerminal(text, type='info') {
            const term = document.getElementById('terminalOutput');
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'err' ? 'log-err' : (type === 'warn' ? 'log-warn' : 'log-info');
            
            div.innerHTML = `<span class="log-time">${time}</span> <span class="${colorClass}">${text}</span>`;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
            
            // Limit history
            if (term.childElementCount > 50) term.removeChild(term.firstChild);
        }

        // --- USERS MANAGEMENT ---
        async function loadWebUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            try {
                const res = await fetch(`${backendUrl}/api/admin/users`);
                const users = await res.json();
                
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="https://ui-avatars.com/api/?name=${u.username}&background=random" style="width:30px; height:30px; border-radius:50%;">
                                <div style="font-weight:bold; color:white;">${u.username}</div>
                            </div>
                        </td>
                        <td>${u.is_admin ? '<span class="role-badge role-admin">Admin</span>' : '<span class="role-badge role-user">Editor</span>'}</td>
                        <td><a href="https://t.me/${u.telegram_username}" target="_blank" style="color:#94a3b8; text-decoration:none;">@${u.telegram_username || '-'}</a></td>
                        <td>${u.is_approved ? '<span style="color:#4ade80">‚óè Active</span>' : '<span style="color:#facc15">‚óè Pending</span>'}</td>
                        <td style="text-align:right">
                            <button class="btn btn-sm" onclick='editUser(${JSON.stringify(u)})' style="padding:5px 10px; background:rgba(255,255,255,0.1);"><i data-feather="edit-2" style="width:14px"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWebUser(${u.id})" style="padding:5px 10px;"><i data-feather="trash" style="width:14px"></i></button>
                        </td>
                    </tr>
                `).join('');
                feather.replace();
            } catch(e) { console.error(e); }
        }

        window.editUser = (u) => {
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editIsAdmin').value = u.is_admin.toString();
            document.getElementById('editIsApproved').checked = u.is_approved;
            document.getElementById('editUserModal').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('editUserModal').style.display = 'none';

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const payload = {
                is_admin: document.getElementById('editIsAdmin').value === 'true',
                is_approved: document.getElementById('editIsApproved').checked,
                allowed_pages: ['index.html'], // Default placeholder
                allowed_channels: []
            };
            
            await fetch(`${backendUrl}/api/admin/users/${id}/update_full`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            closeModal();
            loadWebUsers();
            logToTerminal(`[USR] Updated user #${id}.`);
        });

        window.deleteWebUser = async (id) => {
            if(confirm("Delete user?")) {
                await fetch(`${backendUrl}/api/admin/users/${id}/delete`, { method: 'POST' });
                loadWebUsers();
                logToTerminal(`[USR] Deleted user #${id}.`, 'warn');
            }
        };

        // --- WHITELIST & CHANNELS (Standard) ---
        async function loadWhitelist() {
            const users = await getWhitelist();
            const tbody = document.querySelector('#whitelistTable tbody');
            tbody.innerHTML = users.map(u => `
                <tr><td><code>${u.telegram_id}</code></td><td>${u.note || '-'}</td><td style="text-align:right"><button class="btn btn-danger btn-sm" onclick="removeWlUser('${u.telegram_id}')">X</button></td></tr>
            `).join('');
        }
        document.getElementById('wlForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await addWhitelistUser(document.getElementById('wl_id').value, document.getElementById('wl_note').value);
            document.getElementById('wlForm').reset();
            loadWhitelist();
        });
        window.removeWlUser = async(id) => { if(confirm('Delete?')) { await deleteWhitelistUser(id); loadWhitelist(); } };

        async function loadChannelsTable() {
            const channels = await getChannels();
            const tbody = document.querySelector('#channelsTable tbody');
            tbody.innerHTML = channels.map(c => `
                <tr><td><b>${c.title}</b></td><td><code>${c.telegram_id}</code></td><td style="text-align:right"><button class="btn btn-danger btn-sm" onclick="removeChannel(${c.id})">X</button></td></tr>
            `).join('');
        }
        document.getElementById('chForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await addChannel(document.getElementById('ch_id').value, document.getElementById('ch_title').value);
            document.getElementById('chForm').reset();
            loadChannelsTable();
        });
        window.removeChannel = async(id) => { if(confirm('Delete?')) { await deleteChannel(id); loadChannelsTable(); } };

        // Broadcast Mock
        window.openBroadcastModal = () => {
            const msg = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è —Ä–æ–∑—Å–∏–ª–∫–∏ (–≤—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø–æ–±–∞—á–∞—Ç—å –π–æ–≥–æ):");
            if(msg) {
                // Here you would call a backend endpoint
                logToTerminal(`[BRD] Broadcast sent: "${msg}"`);
                alert("–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!");
            }
        };

    </script>
</body>
</html>