<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | TaskBot Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="auth-guard.js"></script>
    
    <style>
        /* --- ADMIN COMMAND CENTER STYLES --- */
        :root {
            --sidebar-w: 260px;
            --header-h: 70px;
            --bg-darker: #020617;
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #8b5cf6; /* Violet */
            --accent-glow: rgba(139, 92, 246, 0.4);
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-darker);
            font-family: 'Inter', sans-serif;
            color: #f8fafc;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(239, 68, 68, 0.1) 0%, transparent 40%);
        }

        /* Layout */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: var(--sidebar-w);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            position: fixed; height: 100vh; z-index: 50;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logo-area {
            height: var(--header-h);
            display: flex; align-items: center; gap: 12px; padding: 0 24px;
            font-size: 1.25rem; font-weight: 800; color: white;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent);
        }
        
        .nav-list { padding: 20px 10px; flex: 1; overflow-y: auto; }
        .nav-category {
            font-size: 0.7rem; text-transform: uppercase; color: #64748b; 
            font-weight: 700; margin: 15px 12px 8px; letter-spacing: 1px;
        }
        
        .nav-item {
            padding: 10px 14px; border-radius: 10px; cursor: pointer;
            color: #94a3b8; display: flex; align-items: center; gap: 12px;
            font-weight: 500; font-size: 0.9rem; transition: 0.2s;
            margin-bottom: 2px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active {
            background: rgba(139, 92, 246, 0.15); color: #fff;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.1);
        }
        .nav-item i { width: 18px; height: 18px; }

        /* Main Content */
        .admin-main {
            flex: 1; margin-left: var(--sidebar-w);
            padding: 30px; max-width: 1600px;
        }

        .admin-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .page-title h1 { font-size: 1.8rem; margin: 0; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-4px); border-color: rgba(139, 92, 246, 0.3); }
        .stat-icon {
            position: absolute; top: 20px; right: 20px; 
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); color: var(--accent);
        }
        .stat-value { font-size: 2rem; font-weight: 800; margin: 10px 0 5px; color: white; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; }

        /* Modern Table */
        .table-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.3);
        }
        .table-header {
            padding: 20px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02);
        }
        
        table { width: 100%; border-collapse: collapse; }
        th { 
            text-align: left; padding: 16px 24px; color: #64748b; 
            font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
        }
        td { padding: 16px 24px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges & Avatars */
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-avatar { 
            width: 36px; height: 36px; border-radius: 10px; 
            background: linear-gradient(135deg, #3b82f6, #8b5cf6); 
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        .role-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .role-admin { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.3); }
        .role-editor { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-active { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
        .status-pending { background: #f59e0b; }

        /* Action Buttons */
        .action-group { display: flex; gap: 8px; justify-content: flex-end; }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05); color: #cbd5e1; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-icon:hover { background: white; color: black; transform: translateY(-2px); }
        .btn-icon.danger:hover { background: #ef4444; color: white; border-color: #ef4444; }

        /* Terminal Logs */
        .terminal-panel {
            background: #0f172a; border-radius: 16px; border: 1px solid #1e293b;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .terminal-header {
            background: #1e293b; padding: 8px 15px; display: flex; gap: 8px; align-items: center;
        }
        .term-dot { width: 10px; height: 10px; border-radius: 50%; }
        .terminal-body { padding: 15px; height: 200px; overflow-y: auto; color: #94a3b8; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; }
        .log-time { color: #475569; user-select: none; }
        .log-info { color: #3b82f6; } .log-warn { color: #f59e0b; } .log-err { color: #ef4444; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal {
            background: #1e293b; width: 600px; max-width: 90%; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); padding: 30px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.7);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .modal { transform: scale(1); }

        .btn-primary {
            background: var(--accent); color: white; border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .btn-primary:hover { background: #7c3aed; transform: translateY(-2px); }

        /* Responsive */
        .mobile-menu-btn { display: none; }
        @media (max-width: 1024px) {
            .admin-sidebar { transform: translateX(-100%); }
            .admin-sidebar.active { transform: translateX(0); }
            .admin-main { margin-left: 0; }
            .mobile-menu-btn { display: block; position: fixed; bottom: 20px; right: 20px; z-index: 100; background: var(--accent); color: white; border:none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 24px; cursor: pointer; }
        }
    </style>
</head>
<body>

    <div class="admin-wrapper">
        <aside class="admin-sidebar" id="sidebar">
            <div class="logo-area">
                <i data-feather="hexagon"></i> Admin.Pro
            </div>
            
            <div class="nav-list">
                <div class="nav-category">–ì–æ–ª–æ–≤–Ω–µ</div>
                <div class="nav-item active" onclick="switchTab('dashboard')"><i data-feather="grid"></i> –û–≥–ª—è–¥</div>
                <div class="nav-item" onclick="switchTab('users')"><i data-feather="users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
                
                <div class="nav-category">–°–∏—Å—Ç–µ–º–∞</div>
                <div class="nav-item" onclick="switchTab('logs')"><i data-feather="terminal"></i> –õ–æ–≥–∏ & –ü–æ–¥—ñ—ó</div>
                <div class="nav-item" onclick="window.location.href='index.html'"><i data-feather="log-out"></i> –í–∏—Ö—ñ–¥ –≤ App</div>
            </div>
        </aside>

        <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')">‚ò∞</button>

        <main class="admin-main">
            <div class="admin-header">
                <div class="page-title">
                    <h1>–ö–æ–º–∞–Ω–¥–Ω–∏–π –¶–µ–Ω—Ç—Ä</h1>
                    <div style="color: #64748b; font-size: 0.9rem; margin-top: 5px;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–æ–º —Ç–∞ —Å–∏—Å—Ç–µ–º–æ—é</div>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="text-align:right;">
                        <div style="font-weight:700; color:white;">Administrator</div>
                        <div style="font-size:0.75rem; color:#10b981;">‚óè Online</div>
                    </div>
                    <div class="user-avatar" style="width:42px; height:42px; background: #334155;">A</div>
                </div>
            </div>

            <div id="view-dashboard" class="view-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-feather="users"></i></div>
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">–í—Å—å–æ–≥–æ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#10b981"><i data-feather="check-circle"></i></div>
                        <div class="stat-value" id="stat-approved">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ñ –ê–∫–∞—É–Ω—Ç–∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#f59e0b"><i data-feather="user-plus"></i></div>
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">–û—á—ñ–∫—É—é—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 style="margin:0; color:white;">–ë–∞–∑–∞ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                        <div style="position:relative;">
                            <i data-feather="search" style="position:absolute; left:10px; top:10px; width:16px; color:#64748b;"></i>
                            <input type="text" id="userSearch" placeholder="–ü–æ—à—É–∫..." style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:8px 10px 8px 35px; border-radius:8px; color:white; outline:none;">
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                                    <th>–†–æ–ª—å</th>
                                    <th>Telegram</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th style="text-align:right">–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="terminal-panel">
                    <div class="terminal-header">
                        <div class="term-dot" style="background:#ef4444"></div>
                        <div class="term-dot" style="background:#f59e0b"></div>
                        <div class="term-dot" style="background:#10b981"></div>
                        <span style="opacity:0.5; margin-left:10px;">system.log</span>
                    </div>
                    <div class="terminal-body" id="terminalOutput">
                        <div class="log-entry"><span class="log-time">[10:00:01]</span> <span class="log-info">System initialized successfully</span></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="editUserModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <h2 style="margin:0; color:white;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ü—Ä–∞–≤</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:#64748b; cursor:pointer;"><i data-feather="x"></i></button>
            </div>

            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
        <!-- HEADER -->
        <header class="admin-header">
            <div style="display:flex; align-items:center; gap:20px;">
                <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">
                    <i data-feather="menu"></i>
                </button>
                <div class="page-title" id="pageTitle">–û–≥–ª—è–¥ –°–∏—Å—Ç–µ–º–∏</div>
            </div>
            
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="sys-status">
                    <div class="blink"></div> SYSTEM ONLINE
                </div>
                <div style="display:flex; align-items:center; gap:12px; background: rgba(255,255,255,0.05); padding: 5px 12px 5px 5px; border-radius: 50px; border: 1px solid var(--glass-border);">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=8b5cf6&color=fff" style="width:32px; height:32px; border-radius:50%;">
                    <span style="font-size:0.9rem; font-weight:600;">Administrator</span>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="admin-content">
            
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-pane active">
                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-feather="users"></i></div>
                        <div class="stat-val" id="stat-users">0</div>
                        <div class="stat-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#10b981"><i data-feather="check-circle"></i></div>
                        <div class="stat-val" id="stat-tasks">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –ó–∞–≤–¥–∞–Ω—å</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#f59e0b"><i data-feather="clock"></i></div>
                        <div class="stat-val" id="stat-posts">0</div>
                        <div class="stat-label">–í –æ—á—ñ–∫—É–≤–∞–Ω–Ω—ñ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#ef4444"><i data-feather="zap"></i></div>
                        <div class="stat-val" id="stat-ads">0</div>
                        <div class="stat-label">–†–µ–∫–ª–∞–º–Ω–∏—Ö –ö–∞–º–ø–∞–Ω—ñ–π</div>
                    </div>
                </div>

                <div class="grid-complex">
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                            <h3 style="margin:0">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –°–∏—Å—Ç–µ–º–∏</h3>
                            <div style="font-size:0.8rem; color:#94a3b8;">Real-time Update</div>
                        </div>
                        <div style="height:300px; width:100%;">
                            <canvas id="serverChart"></canvas>
                        </div>
                    </div>

                    <div class="panel" style="padding:0; overflow:hidden;">
                        <div class="terminal-window">
                            <div class="term-bar">
                                <div class="dot" style="background:#ef4444"></div>
                                <div class="dot" style="background:#facc15"></div>
                                <div class="dot" style="background:#22c55e"></div>
                                <span style="margin-left:10px; opacity:0.5;">root@taskbot:~</span>
                            </div>
                            <div class="term-content" id="terminalOutput">
                                <div class="log-line"><span class="log-time">INIT</span> <span class="log-info">System initialized...</span></div>
                                <div class="log-line"><span class="log-time">DB</span> <span class="log-info">Connected to PostgreSQL</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENT QUEUE TAB -->
            <div id="tab-content" class="tab-pane">
                <div class="panel" style="min-height: 80vh;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                        <h2 style="margin:0;">–ß–µ—Ä–≥–∞ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h2>
                        <button class="btn btn-primary" onclick="loadContentQueue()"><i data-feather="refresh-cw"></i> –û–Ω–æ–≤–∏—Ç–∏</button>
                    </div>
                    
                    <div id="queue-list">
                        <div style="text-align:center; padding:50px; color:#64748b;">
                            <span class="loader"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                        </div>
                    </div>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="tab-users" class="tab-pane">
                <div class="table-wrapper">
                    <div style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--glass-border);">
                        <h3 style="margin:0;">–ë–∞–∑–∞ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                        <input type="text" id="userSearch" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞..." style="width:250px;">
                    </div>
                    <table id="usersTable">
                        <thead><tr><th>User</th><th>Role</th><th>Telegram</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- WHITELIST TAB -->
            <div id="tab-whitelist" class="tab-pane">
                <div class="grid-complex" style="grid-template-columns: 1fr 2fr;">
                    <div class="panel">
                        <h3 style="margin-top:0;">–î–æ–¥–∞—Ç–∏ –¥–æ Whitelist</h3>
                        <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:20px;">–¶—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑–º–æ–∂—É—Ç—å –ø–∏—Å–∞—Ç–∏ –±–æ—Ç—É –≤ –æ—Å–æ–±–∏—Å—Ç—ñ.</p>
                        <form id="wlForm" style="display:flex; flex-direction:column; gap:15px;">
                            <input type="number" id="wl_id" placeholder="Telegram ID (–Ω–∞–ø—Ä. 123456789)" required>
                            <input type="text" id="wl_note" placeholder="–ù–æ—Ç–∞—Ç–∫–∞ (—ñ–º'—è)" required>
                            <button type="submit" class="btn btn-success">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                        </form>
                    </div>
                    <div class="table-wrapper">
                        <table id="whitelistTable">
                            <thead><tr><th>ID</th><th>Note</th><th style="text-align:right">Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CHANNELS TAB -->
            <div id="tab-channels" class="tab-pane">
                 <div class="grid-complex" style="grid-template-columns: 1fr 2fr;">
                    <div class="panel">
                        <h3 style="margin-top:0;">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ö–∞–Ω–∞–ª</h3>
                        <form id="chForm" style="display:flex; flex-direction:column; gap:15px;">
                            <input type="text" id="ch_id" placeholder="Channel ID (-100...)" required>
                            <input type="text" id="ch_title" placeholder="–ù–∞–∑–≤–∞ –∫–∞–Ω–∞–ª—É" required>
                            <button type="submit" class="btn btn-primary">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏</button>
                        </form>
                    </div>
                    <div class="table-wrapper">
                        <table id="channelsTable">
                            <thead><tr><th>Title</th><th>ID</th><th style="text-align:right">Action</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GLOBAL SETTINGS TAB -->
            <div id="tab-global-settings" class="tab-pane">
                <div class="panel" style="max-width: 800px; margin: 0 auto;">
                    <h2 style="border-bottom:1px solid var(--glass-border); padding-bottom:15px; margin-bottom:25px;">
                        <i data-feather="cpu"></i> AI Configuration
                    </h2>
                    <form id="aiGlobalForm">
                        <div style="margin-bottom:20px;">
                            <label style="display:block; margin-bottom:10px; color:#cbd5e1; font-weight:600;">System Prompt (Default)</label>
                            <textarea id="system_prompt" rows="12" style="font-family:'JetBrains Mono', monospace; line-height:1.5; font-size:0.9rem;" required></textarea>
                            <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">–¶–µ–π –ø—Ä–æ–º–ø—Ç –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—å –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —É —è–∫–∏—Ö –Ω–µ–º–∞—î –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ.</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveAiBtn"><i data-feather="save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é</button>
                    </form>
                </div>
            </div>

            <!-- MAINTENANCE TAB -->
            <div id="tab-maintenance" class="tab-pane">
                <h2 style="margin-bottom:30px;">–°–∏—Å—Ç–µ–º–Ω–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è</h2>
                <div class="grid-stats">
                    <div class="stat-card" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="stat-icon" style="color:#f87171"><i data-feather="trash-2"></i></div>
                        <h3 style="margin:10px 0; font-size:1.2rem;">–û—á–∏—Å—Ç–∫–∞ –õ–æ–≥—ñ–≤</h3>
                        <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:20px;">–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ—Å—Ç—ñ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω—ñ–≤.</p>
                        <button class="btn btn-danger" style="width:100%; justify-content:center;" onclick="alert('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω–æ (Mock)!')">–í–∏–∫–æ–Ω–∞—Ç–∏</button>
                    </div>
                    
                    <div class="stat-card" style="border-color: rgba(16, 185, 129, 0.3);">
                        <div class="stat-icon" style="color:#34d399"><i data-feather="database"></i></div>
                        <h3 style="margin:10px 0; font-size:1.2rem;">–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è</h3>
                        <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:20px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ SQL –¥–∞–º–ø –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.</p>
                        <button class="btn btn-success" style="width:100%; justify-content:center;" onclick="alert('–ë–µ–∫–∞–ø —Å—Ç–≤–æ—Ä–µ–Ω–æ —ñ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ TG!')">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"><i data-feather="refresh-cw"></i></div>
                        <h3 style="margin:10px 0; font-size:1.2rem;">–°–∫–∏–¥–∞–Ω–Ω—è –ö–µ—à—É</h3>
                        <p style="font-size:0.9rem; color:#94a3b8; margin-bottom:20px;">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–∫–∏ –∫–∞–Ω–∞–ª—ñ–≤ —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>
                        <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="location.reload()">Reload App</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:#64748b; cursor:pointer;"><i data-feather="x"></i></button>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div class="modal-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Left Col: Role & Status -->
                    <div>
                        <h4 style="color:#94a3b8; margin-bottom:10px; text-transform:uppercase; font-size:0.75rem;">–û—Å–Ω–æ–≤–Ω–µ</h4>
                        <div style="margin-bottom:15px;">
                            <label style="display:block; margin-bottom:5px; font-size:0.9rem;">–†–æ–ª—å</label>
                            <select id="editIsAdmin">
                                <option value="false">–†–µ–¥–∞–∫—Ç–æ—Ä</option>
                                <option value="true">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label class="feature-checkbox" style="color: white; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editIsApproved" style="width: 18px; height: 18px;">
                                <span>–ê–∫–∞—É–Ω—Ç –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
                            </label>
                        </div>
                    </div>

                    <!-- Right Col: Permissions -->
                    <div>
                        <h4 style="color:#94a3b8; margin-bottom:10px; text-transform:uppercase; font-size:0.75rem;">–î–æ—Å—Ç—É–ø –¥–æ —Å—Ç–æ—Ä—ñ–Ω–æ–∫</h4>
                        <div id="pagesList" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <!-- JS injected checkboxes -->
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="color:#94a3b8; margin-bottom:10px; text-transform:uppercase; font-size:0.75rem;">–î–æ—Å—Ç—É–ø –¥–æ –∫–∞–Ω–∞–ª—ñ–≤</h4>
                    <div id="channelsList" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                         <!-- JS injected checkboxes -->
                    </div>
                </div>
                
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 25px;">
                    <button type="button" class="btn" style="background:transparent; border:1px solid #475569;" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- üöÄ SELF-CONTAINED API LOGIC (No Imports) ---
        const backendUrl = 'https://my-telegram-task-bot-5c4258bd3f9b.herokuapp.com';

        async function apiFetch(endpoint, options = {}) {
            try {
                const username = localStorage.getItem('username') || 'Unknown';
                if (!options.headers) options.headers = {};
                options.headers['X-Username'] = username;

                const response = await fetch(`${backendUrl}${endpoint}`, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error: ${response.status} - ${errorText}`);
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                }
                return true;
            } catch (error) {
                console.error(`API Error ${endpoint}:`, error);
                logToTerminal(`[ERR] API: ${error.message}`, 'err');
                throw error;
            }
        }

        // --- WRAPPER FUNCTIONS ---
        const getScheduledPosts = () => apiFetch('/api/scheduled_posts');
        const getTasks = () => apiFetch('/api/tasks');
        const getSettings = () => apiFetch('/api/settings');
        const updateSettings = (data) => apiFetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const getChannels = () => apiFetch('/api/channels');
        const getWhitelist = () => apiFetch('/api/whitelist');
        const addWhitelistUser = (id, note) => apiFetch('/api/whitelist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegram_id: parseInt(id), note: note }) });
        const deleteWhitelistUser = (id) => apiFetch(`/api/whitelist/${id}/delete`, { method: 'POST' });
        const addChannel = (id, title) => apiFetch('/api/channels', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegram_id: String(id), title: title }) });
        const deleteChannel = (id) => apiFetch(`/api/channels/${id}/delete`, { method: 'POST' });
        const approveScheduledPost = (id) => apiFetch(`/api/scheduled_posts/${id}/approve`, { method: 'POST' });
        const deleteScheduledPost = (id) => apiFetch(`/api/scheduled_posts/${id}/delete`, { method: 'POST' });
        const getAds = () => apiFetch('/api/ads');

        // --- GLOBAL & INIT ---
        let sysChart;
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            switchTab('dashboard', document.querySelector('.nav-item.active'));
            initTerminal();
            initChart();
            loadStats();
            
            // Auto-refresh stats every 30s
            setInterval(loadStats, 30000);
            
            // SSE
            try {
                const eventSource = new EventSource(`${backendUrl}/api/events`);
                eventSource.onmessage = (e) => {
                    logToTerminal(`[SSE] New Event: ${e.data}`);
                    if(e.data.includes('UPDATE')) loadStats();
                };
            } catch(e) { console.log("SSE not supported locally"); }
        });

        window.switchTab = (tabId, element) => {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');

            const titles = {
                'dashboard': '–û–≥–ª—è–¥ –°–∏—Å—Ç–µ–º–∏',
                'content': '–ß–µ—Ä–≥–∞ –ú–æ–¥–µ—Ä–∞—Ü—ñ—ó',
                'users': '–ö–µ—Ä—É–≤–∞–Ω–Ω—è –î–æ—Å—Ç—É–ø–æ–º',
                'whitelist': 'Telegram Whitelist',
                'channels': '–ü—ñ–¥–∫–ª—é—á–µ–Ω—ñ –ö–∞–Ω–∞–ª–∏',
                'global-settings': '–ì–ª–æ–±–∞–ª—å–Ω–∞ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è',
                'maintenance': '–°–∏—Å—Ç–µ–º–Ω—ñ –£—Ç–∏–ª—ñ—Ç–∏'
            };
            document.getElementById('pageTitle').innerText = titles[tabId] || 'Admin';

            if(tabId === 'content') loadContentQueue();
            if(tabId === 'users') loadWebUsers();
            if(tabId === 'whitelist') loadWhitelist();
            if(tabId === 'channels') loadChannelsTable();
            if(tabId === 'global-settings') loadAiSettings();
            
            document.getElementById('sidebar').classList.remove('open');
        };

        // --- DASHBOARD STATS ---
        async function loadStats() {
            try {
                // Fetch individually to avoid Promise.all fail if one endpoint is down
                let statsRes = { total_users: 0, scheduled_posts: 0, active_tasks: 0, active_ads: 0 };
                try { statsRes = await apiFetch('/api/admin/stats'); } catch(e){}

                animateValue("stat-users", 0, statsRes.total_users, 1000);
                
                // Content Queue Badge
                try {
                    const posts = await getScheduledPosts();
                    const pendingPosts = posts.filter(p => p.status === 'PendingReview').length;
                    animateValue("stat-posts", 0, pendingPosts, 1000);
                    if(pendingPosts > 0) {
                        const badge = document.getElementById('badge-queue');
                        badge.style.display = 'inline-block';
                        badge.innerText = pendingPosts;
                    }
                } catch(e){}

                animateValue("stat-tasks", 0, statsRes.active_tasks, 1000);
                animateValue("stat-ads", 0, statsRes.active_ads, 1000);
                
                logToTerminal(`[SYS] Dashboard updated.`);
            } catch(e) {
                console.error(e);
            }
        }

        // --- CONTENT QUEUE LOGIC ---
        window.loadContentQueue = async () => {
            const container = document.getElementById('queue-list');
            container.innerHTML = '<div style="text-align:center; padding:40px;"><span class="loader"></span></div>';
            
            try {
                const posts = await getScheduledPosts();
                const pending = posts.filter(p => p.status === 'PendingReview');
                
                if(pending.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:50px; color:#64748b; background:rgba(255,255,255,0.02); border-radius:12px;">
                            <i data-feather="check-circle" style="width:48px; height:48px; margin-bottom:10px;"></i><br>
                            –í—Å–µ —á–∏—Å—Ç–æ! –ù–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.
                        </div>`;
                    feather.replace();
                    return;
                }

                container.innerHTML = pending.map(post => {
                    let mediaHtml = '';
                    if (post.photoIds.length > 0) {
                        mediaHtml = `<div class="queue-media"><i data-feather="image" style="color:#94a3b8"></i></div>`;
                    } else if (post.videoIds.length > 0) {
                        mediaHtml = `<div class="queue-media"><i data-feather="video" style="color:#94a3b8"></i></div>`;
                    } else {
                        mediaHtml = `<div class="queue-media" style="background:transparent; border:1px dashed #475569;"><i data-feather="file-text" style="color:#475569"></i></div>`;
                    }

                    return `
                    <div class="queue-card">
                        ${mediaHtml}
                        <div class="queue-info">
                            <div class="queue-text">${post.text.replace(/</g, '&lt;').substring(0, 300)}...</div>
                            <div class="queue-meta">
                                <span><i data-feather="user" style="width:12px"></i> ${post.createdBy || 'Unknown'}</span>
                                <span><i data-feather="calendar" style="width:12px"></i> ${new Date(post.postAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="queue-actions">
                            <button class="btn btn-success btn-sm" onclick="approveItem('${post.id}')">
                                <i data-feather="check"></i> –°—Ö–≤–∞–ª–∏—Ç–∏
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectItem('${post.id}')">
                                <i data-feather="x"></i> –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
                            </button>
                            <button class="btn btn-sm" style="background:rgba(255,255,255,0.1)" onclick="window.open('schedule-edit.html?id=${post.id}', '_blank')">
                                <i data-feather="edit-2"></i> –†–µ–¥.
                            </button>
                        </div>
                    </div>`;
                }).join('');
                
                feather.replace();
            } catch(e) {
                container.innerHTML = `<div style="color:#ef4444; text-align:center;">–ü–æ–º–∏–ª–∫–∞: ${e.message}</div>`;
            }
        };

        window.approveItem = async (id) => {
            if(!confirm("–°—Ö–≤–∞–ª–∏—Ç–∏ —Ü–µ–π –ø–æ—Å—Ç?")) return;
            try {
                await approveScheduledPost(id);
                loadContentQueue(); // Reload
                loadStats();
                logToTerminal(`[MOD] Post approved: ${id.substring(0,8)}`, 'success');
            } catch(e) { alert("Error"); }
        };

        window.rejectItem = async (id) => {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏/–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ —Ü–µ–π –ø–æ—Å—Ç?")) return;
            try {
                await deleteScheduledPost(id);
                loadContentQueue();
                loadStats();
                logToTerminal(`[MOD] Post rejected: ${id.substring(0,8)}`, 'warn');
            } catch(e) { alert("Error"); }
        };

        // --- USERS ---
        async function loadWebUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';
            try {
                const users = await apiFetch('/api/admin/users');
                allUsers = users; 
                renderUsersTable(users);
            } catch(e) { 
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#ef4444">${e.message}</td></tr>`;
            }
        }

        function renderUsersTable(users) {
            const tbody = document.querySelector('#usersTable tbody');
            if(users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="https://ui-avatars.com/api/?name=${u.username}&background=random&color=fff" style="width:36px; height:36px; border-radius:10px;">
                            <div>
                                <div style="font-weight:700; font-size:0.95rem; color:white;">${u.username}</div>
                                <div style="font-size:0.8rem; color:#64748b;">ID: ${u.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${u.is_admin ? '<span class="role-badge role-admin">Admin</span>' : '<span class="role-badge role-user">Editor</span>'}</td>
                    <td><a href="https://t.me/${u.telegram_username}" target="_blank" style="color:#94a3b8; text-decoration:none;">@${u.telegram_username || '---'}</a></td>
                    <td>${u.is_approved ? '<span style="color:#10b981; font-weight:600;">‚óè Active</span>' : '<span style="color:#f59e0b; font-weight:600;">‚óè Pending</span>'}</td>
                    <td style="text-align:right">
                        <button class="btn btn-sm" onclick='openEditUser(${JSON.stringify(u).replace(/'/g, "&apos;")})' style="padding:6px 10px; background:rgba(255,255,255,0.1); display:inline-flex;">
                            <i data-feather="settings" style="width:14px;"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWebUser(${u.id})" style="padding:6px 10px; display:inline-flex;">
                            <i data-feather="trash" style="width:14px;"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            feather.replace();
        }
        
        // Search Logic
        document.getElementById('userSearch').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => u.username.toLowerCase().includes(val) || (u.telegram_username && u.telegram_username.toLowerCase().includes(val)));
            renderUsersTable(filtered);
        });

        // Edit User Modal Logic
        window.openEditUser = async (u) => {
            // 1. Basic fields
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editIsAdmin').value = u.is_admin.toString();
            document.getElementById('editIsApproved').checked = u.is_approved;

            // 2. Pages
            const allPages = [
                { id: 'index.html', name: '–°—Ç–≤–æ—Ä–∏—Ç–∏ (Home)' },
                { id: 'schedule.html', name: '–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è' },
                { id: 'task-list.html', name: '–ó–∞–≤–¥–∞–Ω–Ω—è' },
                { id: 'schedule-list.html', name: '–ß–µ—Ä–≥–∞ –ø–æ—Å—Ç—ñ–≤' },
                { id: 'ads.html', name: '–†–µ–∫–ª–∞–º–∞' },
                { id: 'chat.html', name: 'AI –ß–∞—Ç' },
                { id: 'history.html', name: '–ê—Ä—Ö—ñ–≤' },
                { id: 'settings.html', name: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è' },
                { id: 'admin.html', name: 'Admin Panel' }
            ];
            
            // Parse user permissions (JSON string or array)
            let userPages = [];
            try {
                userPages = typeof u.allowed_pages === 'string' ? JSON.parse(u.allowed_pages) : (u.allowed_pages || []);
            } catch(e) { userPages = []; }

            const pagesContainer = document.getElementById('pagesList');
            pagesContainer.innerHTML = allPages.map(p => {
                const checked = userPages.includes(p.id) ? 'checked' : '';
                return `
                    <label class="feature-checkbox" style="font-size:0.85rem; padding: 5px;">
                        <input type="checkbox" value="${p.id}" ${checked} class="page-checkbox">
                        <span>${p.name}</span>
                    </label>
                `;
            }).join('');

            // 3. Channels
            const channelsContainer = document.getElementById('channelsList');
            channelsContainer.innerHTML = '<div style="color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
            
            try {
                const channels = await getChannels();
                let userChannels = [];
                try {
                    // Try to parse just in case, but usually it's array in JSON response
                    userChannels = typeof u.allowed_channels === 'string' ? JSON.parse(u.allowed_channels) : (u.allowed_channels || []);
                } catch(e) { userChannels = []; }

                if (channels.length === 0) {
                     channelsContainer.innerHTML = '<div style="color:#94a3b8">–ù–µ–º–∞—î –∫–∞–Ω–∞–ª—ñ–≤</div>';
                } else {
                    channelsContainer.innerHTML = channels.map(c => {
                        const checked = userChannels.includes(c.id.toString()) ? 'checked' : '';
                        return `
                            <label class="feature-checkbox" style="font-size:0.85rem; padding: 5px;">
                                <input type="checkbox" value="${c.id}" ${checked} class="channel-checkbox">
                                <span>${c.title}</span>
                            </label>
                        `;
                    }).join('');
                }
            } catch(e) {
                channelsContainer.innerHTML = '<div style="color:#ef4444">–ü–æ–º–∏–ª–∫–∞</div>';
            }

            document.getElementById('editUserModal').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('editUserModal').style.display = 'none';
        
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            
            // Collect Pages
            const pageCheckboxes = document.querySelectorAll('.page-checkbox:checked');
            const allowedPages = Array.from(pageCheckboxes).map(cb => cb.value);

            // Collect Channels
            const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
            const allowedChannels = Array.from(channelCheckboxes).map(cb => cb.value);

            const payload = {
                is_admin: document.getElementById('editIsAdmin').value === 'true',
                is_approved: document.getElementById('editIsApproved').checked,
                allowed_pages: allowedPages,
                allowed_channels: allowedChannels
            };
            
            await apiFetch(`/api/admin/users/${id}/update_full`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            closeModal();
            loadWebUsers();
            logToTerminal(`[USR] Permissions updated for user #${id}`);
        });

        window.deleteWebUser = async (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±–µ–∑–ø–æ–≤–æ—Ä–æ—Ç–Ω–æ?")) {
                await apiFetch(`/api/admin/users/${id}/delete`, { method: 'POST' });
                loadWebUsers();
                logToTerminal(`[USR] User #${id} deleted`, 'warn');
            }
        };

        // --- GLOBAL SETTINGS ---
        async function loadAiSettings() {
            try {
                const data = await getSettings();
                document.getElementById('system_prompt').value = data.system_prompt || '';
            } catch(e) { console.error(e); }
        }

        document.getElementById('aiGlobalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveAiBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...'; btn.disabled = true;

            try {
                await updateSettings({ system_prompt: document.getElementById('system_prompt').value });
                alert("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
                logToTerminal("[CFG] AI System Prompt updated successfully");
            } catch(e) { alert("Error"); }
            finally { btn.innerHTML = orig; btn.disabled = false; feather.replace(); }
        });

        // --- WHITELIST & CHANNELS ---
        async function loadWhitelist() {
            const users = await getWhitelist();
            const tbody = document.querySelector('#whitelistTable tbody');
            tbody.innerHTML = users.map(u => `
                <tr><td><code>${u.telegram_id}</code></td><td>${u.note || '-'}</td><td style="text-align:right"><button class="btn btn-danger btn-sm" onclick="removeWlUser('${u.telegram_id}')">X</button></td></tr>
            `).join('');
        }
        document.getElementById('wlForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await addWhitelistUser(document.getElementById('wl_id').value, document.getElementById('wl_note').value);
            document.getElementById('wlForm').reset();
            loadWhitelist();
            logToTerminal(`[WL] User added to whitelist`);
        });
        window.removeWlUser = async(id) => { if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) { await deleteWhitelistUser(id); loadWhitelist(); } };

        async function loadChannelsTable() {
            const channels = await getChannels();
            const tbody = document.querySelector('#channelsTable tbody');
            tbody.innerHTML = channels.map(c => `
                <tr><td><b>${c.title}</b></td><td><code>${c.telegram_id}</code></td><td style="text-align:right"><button class="btn btn-danger btn-sm" onclick="removeChannel(${c.id})">X</button></td></tr>
            `).join('');
        }
        document.getElementById('chForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await addChannel(document.getElementById('ch_id').value, document.getElementById('ch_title').value);
            document.getElementById('chForm').reset();
            loadChannelsTable();
            logToTerminal(`[CH] New channel connected`);
        });
        window.removeChannel = async(id) => { if(confirm('–í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –∫–∞–Ω–∞–ª?')) { await deleteChannel(id); loadChannelsTable(); } };

        // --- UTILS ---
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function initTerminal() {
            logToTerminal("[SYS] Command Center Ready.");
        }

        function logToTerminal(text, type='info') {
            const term = document.getElementById('terminalOutput');
            const div = document.createElement('div');
            div.className = 'log-line';
            const time = new Date().toLocaleTimeString('uk-UA', {hour12:false});
            const colorClass = type === 'err' ? 'log-err' : (type === 'warn' ? 'log-warn' : 'log-info');
            
            div.innerHTML = `<span class="log-time">${time}</span> <span class="${colorClass}">${text}</span>`;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }

        function initChart() {
            const ctx = document.getElementById('serverChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)'); 
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

            sysChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Bot API Latency (ms)',
                        data: Array(20).fill(20),
                        borderColor: '#8b5cf6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { display: false }
                    },
                    animation: false
                }
            });

            setInterval(() => {
                const val = Math.floor(Math.random() * 40) + 15; 
                sysChart.data.datasets[0].data.shift();
                sysChart.data.datasets[0].data.push(val);
                sysChart.update();
            }, 1000);
        }

    </script>
    <script src="nav-loader.js"></script>
    <script src="garland.js" type="module"></script>
    <script>
        if(localStorage.getItem('theme-xmas') === 'true') {
            document.documentElement.classList.add('theme-xmas');
        }
    </script>
</body>
</html>