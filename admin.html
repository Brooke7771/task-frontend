<!DOCTYPE html>
<html lang="uk" class="dark">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º—ñ–Ω –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth-guard.js"></script>
    <style>
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∞–¥–º—ñ–Ω–∫–∏ */
        .btn-sm { padding: 5px 10px; font-size: 0.85em; margin-left: 5px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .badge-active { background: rgba(0, 255, 0, 0.15); color: #4ade80; border: 1px solid #4ade80; }
        .badge-pending { background: rgba(255, 165, 0, 0.15); color: #fbbf24; border: 1px solid #fbbf24; }
        
        /* –°—Ç–∏–ª—ñ —á–µ–∫–±–æ–∫—Å—ñ–≤ —É –º–æ–¥–∞–ª—Ü—ñ */
        .perm-label {
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 8px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer;
        }
        .perm-label:hover { background: rgba(255,255,255,0.05); }
        .perm-label input { width: 18px; height: 18px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-main">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <h1>üëë –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h1>
                <a href="index.html" class="btn" style="width:auto">–í –¥–æ–¥–∞—Ç–æ–∫ -></a>
            </div>
            
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid #555;">
                            <th style="padding:10px;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th style="padding:10px;">–¢–µ–ª–µ–≥—Ä–∞–º/–ü–æ—à—Ç–∞</th>
                            <th style="padding:10px;">–ö–∞–Ω–∞–ª</th>
                            <th style="padding:10px;">–ó–∞–ø–∏—Ç —Ñ—É–Ω–∫—Ü—ñ–π</th>
                            <th style="padding:10px;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="padding:10px;">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="permissionsModal" class="card" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10000; border:1px solid var(--color-primary); width:90%; max-width:450px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);">
        <h2 style="margin-top:0">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É üîê</h2>
        <p id="modalUser" style="color: var(--color-text-light); margin-bottom: 15px;"></p>
        
        <form id="permForm">
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--color-border); border-radius: 8px;">
                <label class="perm-label"><input type="checkbox" value="index.html"> üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ó–∞–≤–¥–∞–Ω—å (index)</label>
                <label class="perm-label"><input type="checkbox" value="task-list.html"> üìã –°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</label>
                <label class="perm-label"><input type="checkbox" value="schedule.html"> üìÖ –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ü–æ—Å—Ç—ñ–≤</label>
                <label class="perm-label"><input type="checkbox" value="schedule-list.html"> üïí –°–ø–∏—Å–æ–∫ –ü–æ—Å—Ç—ñ–≤</label>
                <label class="perm-label"><input type="checkbox" value="ads.html"> üì¢ –†–µ–∫–ª–∞–º–∞</label>
                <label class="perm-label"><input type="checkbox" value="chat.html"> ü§ñ AI –ß–∞—Ç</label>
                <label class="perm-label"><input type="checkbox" value="history.html"> üìú –Ü—Å—Ç–æ—Ä—ñ—è</label>
                <label class="perm-label"><input type="checkbox" value="settings.html"> ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</label>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–∞–≤–∞</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { backendUrl } from './api.js';

        let currentUserId = null;

        // –ú–∞–ø–∞ —Ñ—É–Ω–∫—Ü—ñ–π (—Ç–µ —â–æ —é–∑–µ—Ä –ø—Ä–æ—Å–∏–≤ –ø—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) -> –¥–æ —Ñ–∞–π–ª—ñ–≤ (—Ç–µ —â–æ –º–∏ –¥–æ–∑–≤–æ–ª—è—î–º–æ)
        const featureMap = {
            'tasks': ['index.html', 'task-list.html'],
            'schedule': ['schedule.html', 'schedule-list.html', 'schedule-edit.html'],
            'ads': ['ads.html'],
            'ai': ['chat.html']
        };

        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>';

            try {
                const res = await fetch(`${backendUrl}/api/admin/users`);
                if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏");
                
                const users = await res.json();
                
                tbody.innerHTML = users.map(u => {
                    // –ü–∞—Ä—Å–∏–º–æ JSON –ø–æ–ª—è
                    let requested = [];
                    try { requested = JSON.parse(u.requested_features || "[]"); } catch(e){}
                    
                    let allowed = [];
                    try { allowed = JSON.parse(u.allowed_pages || "[]"); } catch(e){}

                    const reqString = requested.join(", ");
                    const statusBadge = u.is_approved 
                        ? `<span class="badge badge-active">–ê–∫—Ç–∏–≤–Ω–∏–π</span>` 
                        : `<span class="badge badge-pending">–û—á—ñ–∫—É—î</span>`;
                    
                    // –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –≤ —Ñ—É–Ω–∫—Ü—ñ—é
                    const allowedStr = encodeURIComponent(JSON.stringify(allowed));
                    const requestedStr = encodeURIComponent(JSON.stringify(requested));

                    return `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                        <td style="padding:12px;"><strong>${u.username}</strong></td>
                        <td style="padding:12px;">${u.telegram_username || '-'}<br><small style="opacity:0.6">${u.email || '-'}</small></td>
                        <td style="padding:12px;">${u.channel_name || '-'}<br><small style="opacity:0.6">${u.channel_id || '-'}</small></td>
                        <td style="padding:12px; font-size:0.9em; color:var(--color-primary);">${reqString}</td>
                        <td style="padding:12px;">${statusBadge}</td>
                        <td style="padding:12px; white-space: nowrap;">
                            ${!u.is_approved 
                                ? `<button onclick="window.openPermissionsModal(${u.id}, '${u.username}', '${allowedStr}', '${requestedStr}')" class="btn btn-success btn-sm" title="–°—Ö–≤–∞–ª–∏—Ç–∏">‚úÖ</button>` 
                                : `<button onclick="window.openPermissionsModal(${u.id}, '${u.username}', '${allowedStr}', null)" class="btn btn-warning btn-sm" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∞">‚úèÔ∏è</button>`
                            }
                            <button onclick="window.deleteUser(${u.id})" class="btn btn-danger btn-sm" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóë</button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; color:red">–ü–æ–º–∏–ª–∫–∞. –í–∏ –∞–¥–º—ñ–Ω?</td></tr>';
            }
        }

        // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏
        // currentAllowedEncoded - –ø–æ—Ç–æ—á–Ω—ñ –ø—Ä–∞–≤–∞ (–¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)
        // requestedFeaturesEncoded - —â–æ –ø—Ä–æ—Å–∏–≤ (–¥–ª—è –Ω–æ–≤–∏—Ö)
        window.openPermissionsModal = (id, name, currentAllowedEncoded, requestedFeaturesEncoded) => {
            currentUserId = id;
            document.getElementById('modalUser').innerHTML = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: <strong>${name}</strong>`;
            
            // –°–∫–∏–¥–∞—î–º–æ –≤—Å—ñ –≥–∞–ª–æ—á–∫–∏
            const checkboxes = document.querySelectorAll('#permForm input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);

            const currentAllowed = JSON.parse(decodeURIComponent(currentAllowedEncoded) || "[]");
            
            if (currentAllowed.length > 0) {
                // –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø: –°—Ç–∞–≤–∏–º–æ –≥–∞–ª–æ—á–∫–∏, —è–∫—ñ –≤–∂–µ —î
                currentAllowed.forEach(page => {
                    const cb = document.querySelector(`#permForm input[value="${page}"]`);
                    if(cb) cb.checked = true;
                });
            } else if (requestedFeaturesEncoded) {
                // –ù–û–í–ò–ô –Æ–ó–ï–†: –ü—Ä–æ–±—É—î–º–æ –≤–≥–∞–¥–∞—Ç–∏ –≥–∞–ª–æ—á–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∑–∞–ø–∏—Ç—É
                const requested = JSON.parse(decodeURIComponent(requestedFeaturesEncoded) || "[]");
                
                // –ó–∞–≤–∂–¥–∏ –¥–∞—î–º–æ –±–∞–∑–æ–≤—ñ
                ['index.html', 'task-list.html', 'settings.html', 'history.html'].forEach(p => {
                     const cb = document.querySelector(`#permForm input[value="${p}"]`);
                     if(cb) cb.checked = true;
                });

                // –î–æ–¥–∞—î–º–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ
                requested.forEach(req => {
                    const pages = featureMap[req];
                    if (pages) {
                        pages.forEach(p => {
                            const cb = document.querySelector(`#permForm input[value="${p}"]`);
                            if(cb) cb.checked = true;
                        });
                    }
                });
            }

            document.getElementById('permissionsModal').style.display = 'block';
        };

        window.closeModal = () => {
            document.getElementById('permissionsModal').style.display = 'none';
        };

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–∞–≤ (–ø—Ä–∞—Ü—é—î —ñ –¥–ª—è Approve, —ñ –¥–ª—è Edit, –±–æ –±–µ–∫–µ–Ω–¥ —Ä–æ–±–∏—Ç—å UPDATE)
        document.getElementById('permForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const allowed = [];
            e.target.querySelectorAll('input:checked').forEach(cb => allowed.push(cb.value));
            
            // –ó–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ –±–∞–∑–æ–≤—ñ, —â–æ–± –Ω–µ –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ
            if(!allowed.includes('index.html')) allowed.push('index.html');

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";

            try {
                const res = await fetch(`${backendUrl}/api/admin/users/${currentUserId}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // is_approved: true (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ –∞–±–æ –∑–∞–ª–∏—à–∞—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–º)
                    body: JSON.stringify({ is_approved: true, allowed_pages: allowed })
                });
                
                if(res.ok) {
                    closeModal();
                    loadUsers();
                } else {
                    alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è");
                }
            } catch(err) {
                console.error(err);
                alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è");
            } finally {
                btn.disabled = false;
                btn.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–∞–≤–∞";
            }
        });

        window.deleteUser = async (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞? –¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞.")) {
                await fetch(`${backendUrl}/api/admin/users/${id}/delete`, { method: 'POST' });
                loadUsers();
            }
        };

        loadUsers();
    </script>
    <div class="fab-container">
        <div class="fab-options">
            <a href="#" onclick="logout(); return false;" class="fab-option" style="color: var(--color-danger);">
                <i data-feather="log-out"></i><span>–í–∏–π—Ç–∏</span>
            </a>
            <a href="index.html" class="fab-option"><i data-feather="plus-circle"></i><span>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ó–∞–≤–¥–∞–Ω–Ω—è</span></a>
            <a href="task-list.html" class="fab-option"><i data-feather="list"></i><span>–°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</span></a>
            <a href="schedule.html" class="fab-option"><i data-feather="calendar"></i><span>–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –ü–æ—Å—Ç</span></a>
            <a href="schedule-list.html" class="fab-option"><i data-feather="clock"></i><span>–°–ø–∏—Å–æ–∫ –ü–æ—Å—Ç—ñ–≤</span></a>
            
            <a href="ads.html" class="fab-option"><i data-feather="megaphone"></i><span>–†–µ–∫–ª–∞–º–∞</span></a>
            <a href="history.html" class="fab-option"><i data-feather="archive"></i><span>–Ü—Å—Ç–æ—Ä—ñ—è</span></a>
            <a href="chat.html" class="fab-option active"><i data-feather="message-circle"></i><span>AI –ß–∞—Ç</span></a>
            <a href="settings.html" class="fab-option"><i data-feather="settings"></i><span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></a>
            <a href="admin.html" class="fab-option"><i data-feather="settings"></i><span>ADMIN</span></a>
        </div>
        <button class="fab-main" id="fab-toggle">
            <i class="fab-main-icon fab-icon-menu" data-feather="menu"></i>
            <i class="fab-main-icon fab-icon-close" data-feather="x"></i>
        </button>
    </div>
</body>
</html>