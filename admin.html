<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | TaskBot Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="auth-guard.js"></script>
    
    <style>
        /* --- ADMIN COMMAND CENTER STYLES --- */
        :root {
            --sidebar-w: 260px;
            --header-h: 70px;
            --bg-darker: #020617;
            --glass-bg: rgba(15, 23, 42, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #8b5cf6; /* Violet */
            --accent-glow: rgba(139, 92, 246, 0.4);
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-darker);
            font-family: 'Inter', sans-serif;
            color: #f8fafc;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(239, 68, 68, 0.1) 0%, transparent 40%);
        }

        /* Layout */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: var(--sidebar-w);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            position: fixed; height: 100vh; z-index: 50;
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logo-area {
            height: var(--header-h);
            display: flex; align-items: center; gap: 12px; padding: 0 24px;
            font-size: 1.25rem; font-weight: 800; color: white;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent);
        }
        
        .nav-list { padding: 20px 10px; flex: 1; overflow-y: auto; }
        .nav-category {
            font-size: 0.7rem; text-transform: uppercase; color: #64748b; 
            font-weight: 700; margin: 15px 12px 8px; letter-spacing: 1px;
        }
        
        .nav-item {
            padding: 10px 14px; border-radius: 10px; cursor: pointer;
            color: #94a3b8; display: flex; align-items: center; gap: 12px;
            font-weight: 500; font-size: 0.9rem; transition: 0.2s;
            margin-bottom: 2px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active {
            background: rgba(139, 92, 246, 0.15); color: #fff;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.1);
        }
        .nav-item i { width: 18px; height: 18px; }

        /* Main Content */
        .admin-main {
            flex: 1; margin-left: var(--sidebar-w);
            padding: 30px; max-width: 1600px;
        }

        .admin-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .page-title h1 { font-size: 1.8rem; margin: 0; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-4px); border-color: rgba(139, 92, 246, 0.3); }
        .stat-icon {
            position: absolute; top: 20px; right: 20px; 
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); color: var(--accent);
        }
        .stat-value { font-size: 2rem; font-weight: 800; margin: 10px 0 5px; color: white; }
        .stat-label { font-size: 0.85rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; }

        /* Modern Table */
        .table-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.3);
        }
        .table-header {
            padding: 20px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02);
        }
        
        table { width: 100%; border-collapse: collapse; }
        th { 
            text-align: left; padding: 16px 24px; color: #64748b; 
            font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
        }
        td { padding: 16px 24px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges & Avatars */
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-avatar { 
            width: 36px; height: 36px; border-radius: 10px; 
            background: linear-gradient(135deg, #3b82f6, #8b5cf6); 
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        .role-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .role-admin { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.3); }
        .role-editor { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-active { background: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
        .status-pending { background: #f59e0b; }

        /* Action Buttons */
        .action-group { display: flex; gap: 8px; justify-content: flex-end; }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05); color: #cbd5e1; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-icon:hover { background: white; color: black; transform: translateY(-2px); }
        .btn-icon.danger:hover { background: #ef4444; color: white; border-color: #ef4444; }

        /* Terminal Logs */
        .terminal-panel {
            background: #0f172a; border-radius: 16px; border: 1px solid #1e293b;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .terminal-header {
            background: #1e293b; padding: 8px 15px; display: flex; gap: 8px; align-items: center;
        }
        .term-dot { width: 10px; height: 10px; border-radius: 50%; }
        .terminal-body { padding: 15px; height: 200px; overflow-y: auto; color: #94a3b8; }
        .log-entry { margin-bottom: 4px; display: flex; gap: 10px; }
        .log-time { color: #475569; user-select: none; }
        .log-info { color: #3b82f6; } .log-warn { color: #f59e0b; } .log-err { color: #ef4444; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal {
            background: #1e293b; width: 600px; max-width: 90%; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); padding: 30px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.7);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .modal { transform: scale(1); }

        .btn-primary {
            background: var(--accent); color: white; border: none; padding: 10px 20px;
            border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .btn-primary:hover { background: #7c3aed; transform: translateY(-2px); }

        /* Responsive */
        .mobile-menu-btn { display: none; }
        @media (max-width: 1024px) {
            .admin-sidebar { transform: translateX(-100%); }
            .admin-sidebar.active { transform: translateX(0); }
            .admin-main { margin-left: 0; }
            .mobile-menu-btn { display: block; position: fixed; bottom: 20px; right: 20px; z-index: 100; background: var(--accent); color: white; border:none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 24px; cursor: pointer; }
        }
    </style>
</head>
<body>

    <div class="admin-wrapper">
        <aside class="admin-sidebar" id="sidebar">
            <div class="logo-area">
                <i data-feather="hexagon"></i> Admin.Pro
            </div>
            
            <div class="nav-list">
                <div class="nav-category">–ì–æ–ª–æ–≤–Ω–µ</div>
                <div class="nav-item active" onclick="switchTab('dashboard')"><i data-feather="grid"></i> –û–≥–ª—è–¥</div>
                <div class="nav-item" onclick="switchTab('users')"><i data-feather="users"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
                
                <div class="nav-category">–°–∏—Å—Ç–µ–º–∞</div>
                <div class="nav-item" onclick="switchTab('logs')"><i data-feather="terminal"></i> –õ–æ–≥–∏ & –ü–æ–¥—ñ—ó</div>
                <div class="nav-item" onclick="window.location.href='index.html'"><i data-feather="log-out"></i> –í–∏—Ö—ñ–¥ –≤ App</div>
            </div>
        </aside>

        <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')">‚ò∞</button>

        <main class="admin-main">
            <div class="admin-header">
                <div class="page-title">
                    <h1>–ö–æ–º–∞–Ω–¥–Ω–∏–π –¶–µ–Ω—Ç—Ä</h1>
                    <div style="color: #64748b; font-size: 0.9rem; margin-top: 5px;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–æ–º —Ç–∞ —Å–∏—Å—Ç–µ–º–æ—é</div>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="text-align:right;">
                        <div style="font-weight:700; color:white;">Administrator</div>
                        <div style="font-size:0.75rem; color:#10b981;">‚óè Online</div>
                    </div>
                    <div class="user-avatar" style="width:42px; height:42px; background: #334155;">A</div>
                </div>
            </div>

            <div id="view-dashboard" class="view-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i data-feather="users"></i></div>
                        <div class="stat-value" id="stat-users">0</div>
                        <div class="stat-label">–í—Å—å–æ–≥–æ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#10b981"><i data-feather="check-circle"></i></div>
                        <div class="stat-value" id="stat-approved">0</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ñ –ê–∫–∞—É–Ω—Ç–∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:#f59e0b"><i data-feather="user-plus"></i></div>
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">–û—á—ñ–∫—É—é—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h3 style="margin:0; color:white;">–ë–∞–∑–∞ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3>
                        <div style="position:relative;">
                            <i data-feather="search" style="position:absolute; left:10px; top:10px; width:16px; color:#64748b;"></i>
                            <input type="text" id="userSearch" placeholder="–ü–æ—à—É–∫..." style="background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:8px 10px 8px 35px; border-radius:8px; color:white; outline:none;">
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                                    <th>–†–æ–ª—å</th>
                                    <th>Telegram</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th style="text-align:right">–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="terminal-panel">
                    <div class="terminal-header">
                        <div class="term-dot" style="background:#ef4444"></div>
                        <div class="term-dot" style="background:#f59e0b"></div>
                        <div class="term-dot" style="background:#10b981"></div>
                        <span style="opacity:0.5; margin-left:10px;">system.log</span>
                    </div>
                    <div class="terminal-body" id="terminalOutput">
                        <div class="log-entry"><span class="log-time">[10:00:01]</span> <span class="log-info">System initialized successfully</span></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="editUserModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                <h2 style="margin:0; color:white;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ü—Ä–∞–≤</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:#64748b; cursor:pointer;"><i data-feather="x"></i></button>
            </div>

            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <label style="color:#94a3b8; font-size:0.85rem; font-weight:600; display:block; margin-bottom:8px;">–†–æ–ª—å —É —Å–∏—Å—Ç–µ–º—ñ</label>
                        <select id="editIsAdmin" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:8px;">
                            <option value="false">–†–µ–¥–∞–∫—Ç–æ—Ä (Editor)</option>
                            <option value="true">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä (Full Access)</option>
                        </select>
                    </div>
                    <div>
                        <label style="color:#94a3b8; font-size:0.85rem; font-weight:600; display:block; margin-bottom:8px;">–°—Ç–∞—Ç—É—Å –∞–∫–∞—É–Ω—Ç—É</label>
                        <label style="display:flex; align-items:center; gap:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer;">
                            <input type="checkbox" id="editIsApproved" style="width:18px; height:18px;">
                            <span style="color:white; font-size:0.9rem;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
                        </label>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label style="color:#94a3b8; font-size:0.85rem; font-weight:600;">–î–æ—Å—Ç—É–ø –¥–æ —Å—Ç–æ—Ä—ñ–Ω–æ–∫</label>
                        <button type="button" onclick="selectAll('page-checkbox')" style="background:none; border:none; color:var(--accent); font-size:0.8rem; cursor:pointer;">–û–±—Ä–∞—Ç–∏ –≤—Å–µ</button>
                    </div>
                    <div id="pagesList" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; max-height:150px; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px;">
                        </div>
                </div>

                <div style="margin-bottom:30px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label style="color:#94a3b8; font-size:0.85rem; font-weight:600;">–î–æ—Å—Ç—É–ø –¥–æ –∫–∞–Ω–∞–ª—ñ–≤</label>
                        <button type="button" onclick="selectAll('channel-checkbox')" style="background:none; border:none; color:var(--accent); font-size:0.8rem; cursor:pointer;">–û–±—Ä–∞—Ç–∏ –≤—Å–µ</button>
                    </div>
                    <div id="channelsList" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; max-height:150px; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px;">
                        </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" onclick="closeModal()" style="padding:10px 20px; background:transparent; border:1px solid #475569; color:#cbd5e1; border-radius:10px; cursor:pointer;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- API & LOGIC ---
        const backendUrl = 'https://my-telegram-task-bot-5c4258bd3f9b.herokuapp.com';
        let allUsers = [];

        async function apiFetch(endpoint, options = {}) {
            const username = localStorage.getItem('username') || 'Unknown';
            if (!options.headers) options.headers = {};
            options.headers['X-Username'] = username;
            
            try {
                const res = await fetch(`${backendUrl}${endpoint}`, options);
                if(!res.ok) throw new Error(await res.text());
                return res.json();
            } catch(e) {
                logTerminal(`API Error: ${e.message}`, 'err');
                throw e;
            }
        }

        function logTerminal(msg, type='info') {
            const term = document.getElementById('terminalOutput');
            const time = new Date().toLocaleTimeString('uk-UA', {hour12:false});
            const colors = { info: '#3b82f6', warn: '#f59e0b', err: '#ef4444', success: '#10b981' };
            
            const line = document.createElement('div');
            line.className = 'log-entry';
            line.innerHTML = `<span class="log-time">[${time}]</span> <span style="color:${colors[type]}">${msg}</span>`;
            
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;
        }

        // Load Data
        async function loadUsers() {
            try {
                const users = await apiFetch('/api/admin/users');
                allUsers = users;
                renderUsers(users);
                updateStats(users);
                logTerminal(`Loaded ${users.length} users`, 'success');
            } catch(e) { console.error(e); }
        }

        function updateStats(users) {
            document.getElementById('stat-users').innerText = users.length;
            document.getElementById('stat-approved').innerText = users.filter(u => u.is_approved).length;
            document.getElementById('stat-pending').innerText = users.filter(u => !u.is_approved).length;
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            if(users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#64748b;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => {
                const initial = u.username.charAt(0).toUpperCase();
                const roleBadge = u.is_admin 
                    ? `<span class="role-badge role-admin">Admin</span>` 
                    : `<span class="role-badge role-editor">Editor</span>`;
                
                const statusDot = u.is_approved
                    ? `<span class="status-dot status-active"></span> Active`
                    : `<span class="status-dot status-pending"></span> Pending`;

                // Escape quotes for JSON
                const safeUser = JSON.stringify(u).replace(/'/g, "&apos;").replace(/"/g, "&quot;");

                return `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar">${initial}</div>
                            <div>
                                <div style="font-weight:700; font-size:0.95rem; color:white;">${u.username}</div>
                                <div style="font-size:0.75rem; color:#64748b;">ID: ${u.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${roleBadge}</td>
                    <td style="color:#94a3b8;">${u.telegram_username ? '@'+u.telegram_username : '-'}</td>
                    <td style="font-weight:600; font-size:0.85rem; color:#cbd5e1;">${statusDot}</td>
                    <td>
                        <div class="action-group">
                            <button class="btn-icon" onclick="openEdit('${safeUser}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"><i data-feather="settings" style="width:16px;"></i></button>
                            <button class="btn-icon danger" onclick="deleteUser(${u.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏"><i data-feather="trash-2" style="width:16px;"></i></button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            feather.replace();
        }

        // Modal Logic
        window.openEdit = async (userStr) => {
            const u = JSON.parse(userStr.replace(/&quot;/g, '"').replace(/&apos;/g, "'"));
            
            document.getElementById('editUserId').value = u.id;
            document.getElementById('editIsAdmin').value = u.is_admin.toString();
            document.getElementById('editIsApproved').checked = u.is_approved;

            // Load Perms checkboxes
            const pages = [
                {id: 'index.html', name: '–ì–æ–ª–æ–≤–Ω–∞ (–°—Ç–≤–æ—Ä–∏—Ç–∏)'},
                {id: 'schedule.html', name: '–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è'},
                {id: 'task-list.html', name: '–ó–∞–≤–¥–∞–Ω–Ω—è'},
                {id: 'schedule-list.html', name: '–ß–µ—Ä–≥–∞ –ø–æ—Å—Ç—ñ–≤'},
                {id: 'ads.html', name: '–†–µ–∫–ª–∞–º–∞'},
                {id: 'admin.html', name: 'Admin Panel'}
            ];
            
            let userPages = [];
            try { userPages = JSON.parse(u.allowed_pages || '[]'); } catch(e){}

            const pagesHtml = pages.map(p => `
                <label style="display:flex; gap:10px; align-items:center; cursor:pointer;">
                    <input type="checkbox" class="page-checkbox" value="${p.id}" ${userPages.includes(p.id) ? 'checked' : ''}>
                    <span style="color:#cbd5e1; font-size:0.85rem;">${p.name}</span>
                </label>
            `).join('');
            document.getElementById('pagesList').innerHTML = pagesHtml;

            // Channels
            const channelsDiv = document.getElementById('channelsList');
            channelsDiv.innerHTML = '<span class="loader"></span>';
            try {
                const channels = await apiFetch('/api/channels');
                let userChannels = [];
                try { userChannels = JSON.parse(u.allowed_channels || '[]'); } catch(e){}

                channelsDiv.innerHTML = channels.map(c => `
                    <label style="display:flex; gap:10px; align-items:center; cursor:pointer;">
                        <input type="checkbox" class="channel-checkbox" value="${c.id}" ${userChannels.includes(String(c.id)) ? 'checked' : ''}>
                        <span style="color:#cbd5e1; font-size:0.85rem;">${c.title}</span>
                    </label>
                `).join('');
            } catch(e) { channelsDiv.innerHTML = 'Err'; }

            document.querySelector('.modal-overlay').classList.add('open');
        };

        window.closeModal = () => document.querySelector('.modal-overlay').classList.remove('open');
        window.selectAll = (cls) => document.querySelectorAll(`.${cls}`).forEach(cb => cb.checked = true);

        // Submit Edit
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            
            // üî• –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ
            const isAdmin = document.getElementById('editIsAdmin').value === 'true'; // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞ boolean
            const isApproved = document.getElementById('editIsApproved').checked;
            
            const allowedPages = Array.from(document.querySelectorAll('.page-checkbox:checked')).map(cb => cb.value);
            const allowedChannels = Array.from(document.querySelectorAll('.channel-checkbox:checked')).map(cb => cb.value);

            try {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                await apiFetch(`/api/admin/users/${id}/update_full`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        is_admin: isAdmin, // –í–∞–∂–ª–∏–≤–æ!
                        is_approved: isApproved,
                        allowed_pages: allowedPages,
                        allowed_channels: allowedChannels
                    })
                });
                
                closeModal();
                loadUsers(); // Refresh table
                logTerminal(`Updated permissions for user #${id}`, 'success');
            } catch(e) {
                alert("Error saving");
            }
        });

        window.deleteUser = async (id) => {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?")) {
                await apiFetch(`/api/admin/users/${id}/delete`, {method:'POST'});
                loadUsers();
                logTerminal(`Deleted user #${id}`, 'warn');
            }
        };

        // Search
        document.getElementById('userSearch').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => u.username.toLowerCase().includes(val));
            renderUsers(filtered);
        });

        // Init
        feather.replace();
        loadUsers();

        // SSE: refresh channels in modal and reload users on schedule updates
        try {
            const es = new EventSource(`${backendUrl}/api/events`);
            es.onmessage = async (evt) => {
                try {
                    const data = JSON.parse(evt.data);
                    if (data.type === 'UPDATE_CHANNELS') {
                        logTerminal('[SSE] Channels updated', 'info');
                        const overlay = document.querySelector('.modal-overlay');
                        const isOpen = overlay && overlay.classList.contains('open');
                        if (isOpen) {
                            const id = document.getElementById('editUserId').value;
                            if (id) {
                                let user = allUsers.find(u => String(u.id) === String(id));
                                if (user) {
                                    openEdit(JSON.stringify(user).replace(/"/g, '&quot;').replace(/'/g, '&apos;'));
                                } else {
                                    await loadUsers();
                                    user = allUsers.find(u => String(u.id) === String(id));
                                    if (user) openEdit(JSON.stringify(user).replace(/"/g, '&quot;').replace(/'/g, '&apos;'));
                                }
                            }
                        }
                    } else if (data.type === 'UPDATE_SCHEDULE') {
                        logTerminal('[SSE] Schedule updated; refreshing users', 'info');
                        loadUsers();
                    }
                } catch(e) { console.error('SSE parse error', e); }
            };
            es.onerror = () => { es.close(); setTimeout(() => { try { new EventSource(`${backendUrl}/api/events`); } catch{} }, 5000); };
        } catch(e) { console.log('SSE init failed', e); }

    </script>
</body>
</html>