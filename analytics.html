<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ Pro & Tools</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="auth-guard.js"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ —Å—ñ—Ç–∫–∞ –¥–ª—è –±–ª–æ–∫—É –ø–æ—Å–∏–ª–∞–Ω—å */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* –°–∫–æ—Ä–æ—á—É–≤–∞—á –≤—É–∂—á–∏–π, —Ç–∞–±–ª–∏—Ü—è —à–∏—Ä—à–∞ */
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) { .tools-grid { grid-template-columns: 1fr; } }

        .chart-container { position: relative; height: 250px; width: 100%; }

        .kpi-row {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        @media (max-width: 768px) { .kpi-row { grid-template-columns: 1fr 1fr; } }
        
        .kpi-title { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: white; }
        .trend-up { color: #4ade80; }

        /* –¢–∞–±–ª–∏—Ü—ñ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #94a3b8; padding: 12px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; color: #e2e8f0; }
        
        .avatar-circle {
            width: 30px; height: 30px; border-radius: 50%; background: var(--color-primary);
            color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em;
        }

        /* Shortener Input */
        .shortener-box {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .copy-btn {
            background: rgba(255,255,255,0.1); border: none; color: #cbd5e1; cursor: pointer; padding: 5px; border-radius: 6px; transition: 0.2s;
        }
        .copy-btn:hover { color: white; background: var(--color-primary); }
        .link-row { font-family: monospace; color: var(--color-primary); }
        
        .section-header { margin: 40px 0 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: white; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container-main" style="max-width: 1400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h1><i data-feather="bar-chart-2"></i> –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ & –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h1>
            <button onclick="loadAnalytics()" class="btn" style="width: auto; padding: 8px 15px;">
                <i data-feather="refresh-cw" style="width:16px;"></i>
            </button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-title">–ü–æ—Å—Ç—ñ–≤ (7 –¥–Ω—ñ–≤)</div>
                <div class="kpi-value" id="kpi-weekly">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–í—Å—å–æ–≥–æ –ö–ª—ñ–∫—ñ–≤</div>
                <div class="kpi-value" id="kpi-clicks">0</div>
                <div class="kpi-trend trend-up">‚Üó –¢—Ä–∞—Ñ—ñ–∫</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–†–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</div>
                <div class="kpi-value" id="kpi-editors">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–¢–æ–ø –∫–∞–Ω–∞–ª</div>
                <div class="kpi-value" id="kpi-top-channel" style="font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
            </div>
        </div>

        <!-- Add CSV Export Button Here -->
        <div style="margin-bottom: 30px; display: flex; justify-content: flex-end;">
            <a href="/api/analytics/export/csv" target="_blank" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none; width: auto;">
                <i data-feather="download"></i> –ï–∫—Å–ø–æ—Ä—Ç —ñ—Å—Ç–æ—Ä—ñ—ó (CSV)
            </a>
        </div>

        <div class="section-header"><i data-feather="link"></i> –°–∫–æ—Ä–æ—á—É–≤–∞—á –ø–æ—Å–∏–ª–∞–Ω—å</div>
        
        <div class="tools-grid">
            <div class="card">
                <h2>‚úÇÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</h2>
                <p style="color:#94a3b8; font-size:0.9em; margin-bottom:15px;">–°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤ —É –ø–æ—Å—Ç–∞—Ö.</p>
                
                <div class="form-group">
                    <label>–î–æ–≤–≥–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                    <input type="text" id="longUrl" placeholder="https://example.com/very-long-article...">
                </div>
                <button class="btn btn-primary" onclick="createShortLink()">–°–∫–æ—Ä–æ—Ç–∏—Ç–∏</button>
                
                <div id="shortenerResult" style="margin-top:20px; display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid var(--color-success);">
                    <label style="color:var(--color-success)">–ì–æ—Ç–æ–≤–æ!</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="text" id="shortUrlOutput" readonly style="background:transparent; border:none; color:white; padding:0;">
                        <button class="copy-btn" onclick="copyToClipboard()"><i data-feather="copy"></i></button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìú –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Å–∏–ª–∞–Ω—å</h2>
                <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original</th>
                                <th>Short</th>
                                <th>Clicks</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody">
                            <tr><td colspan="4" style="text-align:center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section-header"><i data-feather="pie-chart"></i> –ì—Ä–∞—Ñ—ñ–∫–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>

        <div class="analytics-grid">
            <div class="card" style="grid-column: span 2;">
                <h2>üìà –¢—Ä–µ–Ω–¥ –ü—É–±–ª—ñ–∫–∞—Ü—ñ–π</h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üçï –¢–∏–ø–∏ –ö–æ–Ω—Ç–µ–Ω—Ç—É</h2>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="card">
                <h2>‚è∞ –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (–ì–æ–¥–∏–Ω–∏)</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ –î–Ω—ñ –¢–∏–∂–Ω—è</h2>
                <div class="chart-container">
                    <canvas id="dayOfWeekChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üì¢ –¢–æ–ø –ö–∞–Ω–∞–ª—ñ–≤</h2>
                <div class="chart-container">
                    <canvas id="channelsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –†–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th width="50"></th>
                            <th>–Ü–º'—è</th>
                            <th>–ü–æ—Å—Ç—ñ–≤</th>
                            <th>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="editorsTable"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC (MODULE) -->
    <script type="module">
        import { backendUrl } from './api.js';
        
        // --- AUTH & GLOBALS ---
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        // Make functions global for HTML event attributes (onclick)
        window.loadAnalytics = loadAnalytics;
        window.createShortLink = createShortLink;
        window.copyToClipboard = copyToClipboard;

        // --- DASHBOARD LOGIC ---
        async function loadAnalytics() {
            try {
                const res = await fetch(`${backendUrl}/api/analytics`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    if(res.status === 401) window.location.href = 'login.html';
                    throw new Error('API Request Failed');
                }
                
                const data = await res.json();
                renderDashboard(data);
            } catch (error) {
                console.error("Analytics Load Error:", error);
            }
        }

        async function createShortLink() {
            const urlInput = document.getElementById('longUrl');
            if(!urlInput || !urlInput.value) return;
            
            try {
                const res = await fetch(`${backendUrl}/api/shortner/create`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ url: urlInput.value })
                });
                
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('shortenerResult').style.display = 'block';
                    document.getElementById('shortUrlOutput').value = data.short_url;
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è');
            }
        }

        function copyToClipboard() {
            const copyText = document.getElementById("shortUrlOutput");
            copyText.select();
            document.execCommand("copy");
            alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!");
        }

        function renderDashboard(data) {
            // KPI Cards
            document.getElementById('kpi-weekly').innerText = data.weekly_trend.reduce((a, b) => a + b.count, 0);
            document.getElementById('kpi-clicks').innerText = data.total_clicks;
            document.getElementById('kpi-editors').innerText = data.editor_stats.length;
            document.getElementById('kpi-top-channel').innerText = data.top_channels[0] ? data.top_channels[0].title : '-';

            // Editors Table
            const editorsBody = document.getElementById('editorsTable');
            editorsBody.innerHTML = data.editor_stats.map(ed => `
                <tr>
                    <td><div class="avatar-circle">${ed.username.substring(0,2).toUpperCase()}</div></td>
                    <td>${ed.username}</td>
                    <td>${ed.total_posts}</td>
                    <td>
                        <div style="width: 100%; max-width: 100px; background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px;">
                             <div style="width: ${Math.min(100, ed.total_posts * 2)}%; height: 100%; background: var(--color-primary); border-radius: 2px;"></div>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Links Table
            const linksBody = document.getElementById('linksTableBody');
            if(data.recent_links.length > 0) {
                linksBody.innerHTML = data.recent_links.map(l => `
                    <tr>
                        <td class="link-row" title="${l.original_url}">${l.original_url.substring(0, 30)}...</td>
                        <td><a href="/s/${l.id}" target="_blank" style="color:var(--color-success)">/s/${l.id}</a></td>
                        <td>${l.clicks}</td>
                        <td>${new Date(l.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } else {
                linksBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#64748b">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</td></tr>';
            }

            // Charts
            updateChart('trendChart', 'line', data.weekly_trend.map(d => d.date), [{
                label: '–ü–æ—Å—Ç–∏',
                data: data.weekly_trend.map(d => d.count),
                borderColor: '#38bdf8',
                backgroundColor: 'rgba(56, 189, 248, 0.1)',
                fill: true,
                tension: 0.4
            }]);

            updateChart('typeChart', 'doughnut', data.content_types.map(d => d.post_type), [{
                data: data.content_types.map(d => d.count),
                backgroundColor: ['#f472b6', '#34d399', '#fbbf24', '#a78bfa', '#60a5fa'],
                borderWidth: 0
            }]);

            // Hourly Chart (Normalize to 0-23)
            const hours = Array(24).fill(0);
            data.hourly_activity.forEach(d => hours[d.hour] = d.count);
            updateChart('hourlyChart', 'bar', hours.map((_, i) => `${i}:00`), [{
                label: '–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
                data: hours,
                backgroundColor: '#818cf8',
                borderRadius: 4
            }]);

            // Day of Week
            const daysMap = {1: '–ü–Ω', 2: '–í—Ç', 3: '–°—Ä', 4: '–ß—Ç', 5: '–ü—Ç', 6: '–°–±', 0: '–ù–¥', 7: '–ù–¥' };
            const daysValues = Array(8).fill(0); // Index 1-7
            data.day_of_week_stats.forEach(d => { if(d.day_index) daysValues[Math.round(d.day_index)] = d.count; });
            // Extract 1-7
            const daysLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
            const daysData = [daysValues[1], daysValues[2], daysValues[3], daysValues[4], daysValues[5], daysValues[6], daysValues[7]];
             
            updateChart('dayOfWeekChart', 'bar', daysLabels, [{
                label: '–ü–æ—Å—Ç–∏',
                data: daysData,
                backgroundColor: '#34d399',
                borderRadius: 4
            }]);

            updateChart('channelsChart', 'bar', data.top_channels.map(c => c.title.substring(0,10)), [{
                label: '–ü–æ—Å—Ç–∏',
                data: data.top_channels.map(c => c.count),
                backgroundColor: '#fca5a5',
                borderRadius: 4,
                indexAxis: 'y'
            }], { indexAxis: 'y' });
        }

        // --- CHART HELPER ---
        function updateChart(canvasId, type, labels, datasets, extraOptions = {}) {
            const ctx = document.getElementById(canvasId);
            if(!ctx) return;
            
            if (Chart.getChart(ctx)) {
                Chart.getChart(ctx).destroy();
            }

            // Global Chart Defaults
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

            new Chart(ctx, {
                type: type,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type === 'doughnut' } },
                    scales: type === 'doughnut' ? {} : {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    },
                    ...extraOptions
                }
            });
        }
        
        // Expose loadAnalytics globally so the button can call it
        window.loadAnalytics = loadAnalytics;

        // Initial Load
        loadAnalytics();
        feather.replace();
    </script>

    <script src="nav-loader.js"></script>
    <script src="garland.js" type="module"></script>
</body>
</html>