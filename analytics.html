<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ Pro & Tools</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="auth-guard.js"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ —Å—ñ—Ç–∫–∞ –¥–ª—è –±–ª–æ–∫—É –ø–æ—Å–∏–ª–∞–Ω—å */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* –°–∫–æ—Ä–æ—á—É–≤–∞—á –≤—É–∂—á–∏–π, —Ç–∞–±–ª–∏—Ü—è —à–∏—Ä—à–∞ */
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) { .tools-grid { grid-template-columns: 1fr; } }

        .chart-container { position: relative; height: 250px; width: 100%; }

        .kpi-row {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        @media (max-width: 768px) { .kpi-row { grid-template-columns: 1fr 1fr; } }
        
        .kpi-title { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: white; }
        .trend-up { color: #4ade80; }

        /* –¢–∞–±–ª–∏—Ü—ñ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #94a3b8; padding: 12px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; color: #e2e8f0; }
        
        .avatar-circle {
            width: 30px; height: 30px; border-radius: 50%; background: var(--color-primary);
            color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em;
        }

        /* Shortener Input */
        .shortener-box {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .copy-btn {
            background: rgba(255,255,255,0.1); border: none; color: #cbd5e1; cursor: pointer; padding: 5px; border-radius: 6px; transition: 0.2s;
        }
        .copy-btn:hover { color: white; background: var(--color-primary); }
        .link-row { font-family: monospace; color: var(--color-primary); }
        
        .section-header { margin: 40px 0 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; color: white; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container-main" style="max-width: 1400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h1><i data-feather="bar-chart-2"></i> –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ & –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h1>
            <button onclick="loadAnalytics()" class="btn" style="width: auto; padding: 8px 15px;">
                <i data-feather="refresh-cw" style="width:16px;"></i>
            </button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-title">–ü–æ—Å—Ç—ñ–≤ (7 –¥–Ω—ñ–≤)</div>
                <div class="kpi-value" id="kpi-weekly">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–í—Å—å–æ–≥–æ –ö–ª—ñ–∫—ñ–≤</div>
                <div class="kpi-value" id="kpi-clicks">0</div>
                <div class="kpi-trend trend-up">‚Üó –¢—Ä–∞—Ñ—ñ–∫</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–†–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</div>
                <div class="kpi-value" id="kpi-editors">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–¢–æ–ø –∫–∞–Ω–∞–ª</div>
                <div class="kpi-value" id="kpi-top-channel" style="font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
            </div>
        </div>

        <div class="section-header"><i data-feather="link"></i> –°–∫–æ—Ä–æ—á—É–≤–∞—á –ø–æ—Å–∏–ª–∞–Ω—å</div>
        
        <div class="tools-grid">
            <div class="card">
                <h2>‚úÇÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</h2>
                <p style="color:#94a3b8; font-size:0.9em; margin-bottom:15px;">–°—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ—Ä–æ—Ç–∫–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫–ª—ñ–∫—ñ–≤ —É –ø–æ—Å—Ç–∞—Ö.</p>
                
                <div class="form-group">
                    <label>–î–æ–≤–≥–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                    <input type="text" id="longUrl" placeholder="https://example.com/very-long-article...">
                </div>
                <button class="btn btn-primary" onclick="createShortLink()">–°–∫–æ—Ä–æ—Ç–∏—Ç–∏</button>
                
                <div id="shortenerResult" style="margin-top:20px; display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid var(--color-success);">
                    <label style="color:var(--color-success)">–ì–æ—Ç–æ–≤–æ!</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <input type="text" id="shortUrlOutput" readonly style="background:transparent; border:none; color:white; padding:0;">
                        <button class="copy-btn" onclick="copyToClipboard()"><i data-feather="copy"></i></button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìú –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Å–∏–ª–∞–Ω—å</h2>
                <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original</th>
                                <th>Short</th>
                                <th>Clicks</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody">
                            <tr><td colspan="4" style="text-align:center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section-header"><i data-feather="pie-chart"></i> –ì—Ä–∞—Ñ—ñ–∫–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>

        <div class="analytics-grid">
            <div class="card" style="grid-column: span 2;">
                <h2>üìà –¢—Ä–µ–Ω–¥ –ü—É–±–ª—ñ–∫–∞—Ü—ñ–π</h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üçï –¢–∏–ø–∏ –ö–æ–Ω—Ç–µ–Ω—Ç—É</h2>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="card">
                <h2>‚è∞ –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (–ì–æ–¥–∏–Ω–∏)</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ –î–Ω—ñ –¢–∏–∂–Ω—è</h2>
                <div class="chart-container">
                    <canvas id="dayOfWeekChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üì¢ –¢–æ–ø –ö–∞–Ω–∞–ª—ñ–≤</h2>
                <div class="chart-container">
                    <canvas id="channelsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –†–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th width="50"></th>
                            <th>–Ü–º'—è</th>
                            <th>–ü–æ—Å—Ç—ñ–≤</th>
                            <th>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody id="editorsTable"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { backendUrl } from './api.js';
        feather.replace();

        // Chart.js Config
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        let trendChart, typeChart, hourlyChart, channelsChart, dayOfWeekChart;

        // --- SHORTENER LOGIC ---
        window.createShortLink = async () => {
            const url = document.getElementById('longUrl').value;
            if(!url) return alert("–í–≤–µ–¥—ñ—Ç—å URL");

            try {
                const res = await fetch(`${backendUrl}/api/links/shorten`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                
                document.getElementById('shortenerResult').style.display = 'block';
                document.getElementById('shortUrlOutput').value = data.short_url;
                loadAnalytics(); // Refresh table
            } catch(e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—ñ");
            }
        };

        window.copyToClipboard = () => {
            const copyText = document.getElementById("shortUrlOutput");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!");
        };

        // --- ANALYTICS LOGIC ---
        window.loadAnalytics = async () => {
            // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–≤—ñ–∑—É–∞–ª—å–Ω–æ)
            document.getElementById('kpi-weekly').textContent = '...';
            
            try {
                const res = await fetch(`${backendUrl}/api/analytics/dashboard`);
                
                // üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Server Error: ${errorText}`);
                }

                const data = await res.json();
                
                updateKPI(data);
                renderTrendChart(data.weekly_trend);
                renderTypeChart(data.content_types);
                renderHourlyChart(data.hourly_activity);
                renderChannelsChart(data.top_channels);
                renderEditorsTable(data.editor_stats);
                
                // New Functions
                renderLinksTable(data.recent_links);
                renderDayOfWeekChart(data.day_of_week_stats);

            } catch (e) {
                console.error("Analytics Error Details:", e);
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –ø—Ä—è–º–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, —â–æ–± –≤–∏ –±–∞—á–∏–ª–∏ –ø—Ä–∏—á–∏–Ω—É
                document.querySelector('.container-main').insertAdjacentHTML('afterbegin', 
                    `<div style="background: #ef4444; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</strong> ${e.message}
                     </div>`
                );
            }
        };

        function updateKPI(data) {
            const weeklyTotal = data.weekly_trend.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('kpi-weekly').textContent = weeklyTotal;
            document.getElementById('kpi-clicks').textContent = data.total_clicks;
            document.getElementById('kpi-editors').textContent = data.editor_stats.length;
            
            if(data.top_channels.length > 0) {
                document.getElementById('kpi-top-channel').textContent = data.top_channels[0].title;
            }
        }

        // --- NEW RENDERERS ---
        
        function renderLinksTable(links) {
            const tbody = document.getElementById('linksTableBody');
            if(!links || links.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#64748b;">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</td></tr>';
                return;
            }
            
            // Assume backendUrl doesn't have trailing slash, but link ID needs context.
            // Actually, we can reconstruct the full short URL if we know the base.
            // Or just show the ID.
            
            tbody.innerHTML = links.map(l => {
                const shortUrl = `${window.location.protocol}//${window.location.host}/l/${l.id}`; // Approximate display
                return `
                <tr>
                    <td title="${l.original_url}" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${l.original_url}
                    </td>
                    <td><a href="${backendUrl}/l/${l.id}" target="_blank" class="link-row">/l/${l.id}</a></td>
                    <td><span style="color:#4ade80; font-weight:bold;">${l.clicks}</span></td>
                    <td>${new Date(l.created_at).toLocaleDateString()}</td>
                </tr>
                `;
            }).join('');
        }

        function renderDayOfWeekChart(data) {
            const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
            if(dayOfWeekChart) dayOfWeekChart.destroy();

            // Map 1-7 (Postgres ISODOW) to Names
            // Note: Postgres ISODOW: 1=Monday, 7=Sunday
            // But data array might be sparse. Let's create a full array.
            
            const days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–ù–¥"];
            const counts = new Array(7).fill(0);
            
            if(data) {
                data.forEach(d => {
                    if(d.day_index >= 1 && d.day_index <= 7) {
                        counts[d.day_index - 1] = d.count;
                    }
                });
            }

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó',
                        data: counts,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)', // Amber
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- EXISTING RENDERERS (Simplified for brevity) ---

        function renderTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)'); 
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

            if(trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó',
                        data: data.map(d => d.count),
                        borderColor: '#8b5cf6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } } }
            });
        }

        function renderTypeChart(data) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            if(typeChart) typeChart.destroy();
            const labels = data.map(d => d.post_type === 'ad' ? '–†–µ–∫–ª–∞–º–∞' : (d.post_type === 'scheduled' ? '–ü–ª–∞–Ω' : d.post_type));
            typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: ['#ec4899', '#8b5cf6', '#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } }, cutout: '70%' }
            });
        }

        function renderHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if(hourlyChart) hourlyChart.destroy();
            const fullData = new Array(24).fill(0);
            data.forEach(d => fullData[d.hour] = d.count);
            const labels = fullData.map((_, i) => `${i}:00`);

            hourlyChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
                        data: fullData,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { color: 'rgba(255,255,255,0.1)' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { display: false, backdropColor: 'transparent' } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderChannelsChart(data) {
            const ctx = document.getElementById('channelsChart').getContext('2d');
            if(channelsChart) channelsChart.destroy();
            channelsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.title.substring(0, 15) + '...'),
                    datasets: [{
                        label: '–ü–æ—Å—Ç—ñ–≤',
                        data: data.map(d => d.count),
                        backgroundColor: '#10b981', // Green
                        borderRadius: 4
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { grid: { display: false } } } }
            });
        }

        function renderEditorsTable(data) {
            const tbody = document.getElementById('editorsTable');
            tbody.innerHTML = '';
            const maxPosts = Math.max(...data.map(e => e.total_posts)) || 1;
            data.forEach(e => {
                const percent = Math.round((e.total_posts / maxPosts) * 100);
                const initial = e.username.charAt(0).toUpperCase();
                tbody.innerHTML += `<tr><td><div class="avatar-circle">${initial}</div></td><td>${e.username}</td><td style="font-weight:bold; color:white;">${e.total_posts}</td><td><div style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;"><div style="width:${percent}%; height:100%; background:var(--color-primary);"></div></div></td></tr>`;
            });
        }

        loadAnalytics();
    </script>
    <script src="nav-loader.js"></script>
    <script src="garland.js" type="module"></script>
</body>
</html>