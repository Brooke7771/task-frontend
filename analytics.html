<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="auth-guard.js"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        
        .kpi-title { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: white; }
        .kpi-trend { font-size: 0.8rem; margin-top: 5px; }
        .trend-up { color: #4ade80; }
        .trend-neutral { color: #94a3b8; }

        @media (max-width: 768px) {
            .kpi-row { grid-template-columns: 1fr 1fr; }
        }
        
        /* –¢–∞–±–ª–∏—Ü—è */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #94a3b8; padding: 10px; font-size: 0.85rem; }
        td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; }
        .avatar-circle {
            width: 30px; height: 30px; border-radius: 50%; background: var(--color-primary);
            color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em;
        }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container-main" style="max-width: 1400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h1><i data-feather="bar-chart-2"></i> –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ Pro</h1>
            <button onclick="loadAnalytics()" class="btn" style="width: auto; padding: 8px 15px;">
                <i data-feather="refresh-cw" style="width:16px;"></i>
            </button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-title">–í—Å—å–æ–≥–æ –ø–æ—Å—Ç—ñ–≤ (7 –¥–Ω—ñ–≤)</div>
                <div class="kpi-value" id="kpi-weekly">0</div>
                <div class="kpi-trend trend-neutral">–î–∏–Ω–∞–º—ñ–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–í—Å—å–æ–≥–æ –ö–ª—ñ–∫—ñ–≤</div>
                <div class="kpi-value" id="kpi-clicks">0</div>
                <div class="kpi-trend trend-up">–ó–∞ –≤–µ—Å—å —á–∞—Å</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–ê–∫—Ç–∏–≤–Ω–∏—Ö —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</div>
                <div class="kpi-value" id="kpi-editors">0</div>
                <div class="kpi-trend trend-neutral">–ó–∞ –º—ñ—Å—è—Ü—å</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–¢–æ–ø –∫–∞–Ω–∞–ª</div>
                <div class="kpi-value" id="kpi-top-channel" style="font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
                <div class="kpi-trend">–ù–∞–π–±—ñ–ª—å—à–µ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="card" style="grid-column: span 2;">
                <h2>üìà –¢—Ä–µ–Ω–¥ –ü—É–±–ª—ñ–∫–∞—Ü—ñ–π</h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üçï –¢–∏–ø–∏ –ö–æ–Ω—Ç–µ–Ω—Ç—É</h2>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="card">
                <h2>‚è∞ –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø–æ –ì–æ–¥–∏–Ω–∞—Ö</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üì¢ –¢–æ–ø –ö–∞–Ω–∞–ª—ñ–≤</h2>
                <div class="chart-container">
                    <canvas id="channelsChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –†–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th width="50"></th>
                                <th>–Ü–º'—è</th>
                                <th>–ü–æ—Å—Ç—ñ–≤</th>
                                <th>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="editorsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { backendUrl } from './api.js';
        feather.replace();

        // Chart.js Global Config for Dark Theme
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        let trendChart, typeChart, hourlyChart, channelsChart;

        async function loadAnalytics() {
            try {
                const res = await fetch(`${backendUrl}/api/analytics/dashboard`);
                const data = await res.json();
                
                updateKPI(data);
                renderTrendChart(data.weekly_trend);
                renderTypeChart(data.content_types);
                renderHourlyChart(data.hourly_activity);
                renderChannelsChart(data.top_channels);
                renderEditorsTable(data.editor_stats);

            } catch (e) {
                console.error("Analytics Error", e);
            }
        }

        function updateKPI(data) {
            const weeklyTotal = data.weekly_trend.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('kpi-weekly').textContent = weeklyTotal;
            document.getElementById('kpi-clicks').textContent = data.total_clicks;
            document.getElementById('kpi-editors').textContent = data.editor_stats.length;
            
            if(data.top_channels.length > 0) {
                document.getElementById('kpi-top-channel').textContent = data.top_channels[0].title;
            }
        }

        function renderTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)'); // Primary color
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

            if(trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó',
                        data: data.map(d => d.count),
                        borderColor: '#8b5cf6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#8b5cf6',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderTypeChart(data) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            if(typeChart) typeChart.destroy();

            // Mapping types to readable names
            const labels = data.map(d => {
                if(d.post_type === 'ad') return '–†–µ–∫–ª–∞–º–∞';
                if(d.post_type === 'scheduled') return '–ü–ª–∞–Ω';
                if(d.post_type === 'instant') return '–ú–∏—Ç—Ç—î–≤–æ';
                return d.post_type;
            });

            typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: ['#ec4899', '#8b5cf6', '#10b981', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                    },
                    cutout: '70%'
                }
            });
        }

        function renderHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if(hourlyChart) hourlyChart.destroy();

            // Fill empty hours
            const fullData = new Array(24).fill(0);
            data.forEach(d => fullData[d.hour] = d.count);
            const labels = fullData.map((_, i) => `${i}:00`);

            hourlyChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
                        data: fullData,
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { display: false, backdropColor: 'transparent' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderChannelsChart(data) {
            const ctx = document.getElementById('channelsChart').getContext('2d');
            if(channelsChart) channelsChart.destroy();

            channelsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.title.substring(0, 15) + '...'),
                    datasets: [{
                        label: '–ü–æ—Å—Ç—ñ–≤',
                        data: data.map(d => d.count),
                        backgroundColor: '#f59e0b',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function renderEditorsTable(data) {
            const tbody = document.getElementById('editorsTable');
            tbody.innerHTML = '';
            
            const maxPosts = Math.max(...data.map(e => e.total_posts)) || 1;

            data.forEach(e => {
                const percent = Math.round((e.total_posts / maxPosts) * 100);
                const initial = e.username.charAt(0).toUpperCase();
                
                tbody.innerHTML += `
                    <tr>
                        <td><div class="avatar-circle">${initial}</div></td>
                        <td>${e.username}</td>
                        <td style="font-weight:bold; color:white;">${e.total_posts}</td>
                        <td>
                            <div style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
                                <div style="width:${percent}%; height:100%; background:var(--color-primary);"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        loadAnalytics();
    </script>
    <script src="nav-loader.js"></script>
    <script src="garland.js" type="module"></script>
</body>
</html>