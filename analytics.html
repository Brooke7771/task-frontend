<!DOCTYPE html>
<html lang="uk" class="dark theme-xmas">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналітика 2.0</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="auth-guard.js"></script>
    <style>
        /* --- Heatmap Styles --- */
        .heatmap-container {
            overflow-x: auto; padding-bottom: 10px;
        }
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 12px); /* 7 днів тижня */
            grid-auto-flow: column; /* Стовпчики - це тижні */
            gap: 3px;
            width: max-content;
        }
        .day-cell {
            width: 12px; height: 12px; border-radius: 2px;
            background: rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .day-cell:hover { transform: scale(1.3); z-index: 10; border: 1px solid rgba(255,255,255,0.5); }
        
        /* Рівні активності */
        .lvl-0 { background: rgba(255,255,255,0.05); }
        .lvl-1 { background: rgba(16, 185, 129, 0.2); }
        .lvl-2 { background: rgba(16, 185, 129, 0.4); }
        .lvl-3 { background: rgba(16, 185, 129, 0.7); }
        .lvl-4 { background: #10b981; box-shadow: 0 0 5px #10b981; }

        /* KPI Table */
        .kpi-table th { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; padding: 15px; text-align: left; }
        .kpi-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .progress-bar {
            height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px;
        }
        .progress-fill { height: 100%; background: var(--color-primary); width: 0; transition: width 1s ease; }

        /* Shortener Box */
        .shortener-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px;
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
        }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container-main" style="max-width: 1200px;">
        <h1><i data-feather="bar-chart-2"></i> Аналітика 2.0</h1>

        <div class="card">
            <h2><i data-feather="grid"></i> Активність Публікацій (Рік)</h2>
            <div class="heatmap-container">
                <div id="heatmap" class="heatmap-grid"></div>
            </div>
            <div style="display:flex; justify-content: flex-end; gap: 5px; margin-top: 10px; font-size: 0.8em; color: #64748b; align-items: center;">
                Менше
                <div class="day-cell lvl-0"></div>
                <div class="day-cell lvl-2"></div>
                <div class="day-cell lvl-4"></div>
                Більше
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            
            <div class="card">
                <h2><i data-feather="users"></i> Ефективність Редакторів (30 днів)</h2>
                <table class="kpi-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Редактор</th>
                            <th>Постів</th>
                            <th>Вклад</th>
                        </tr>
                    </thead>
                    <tbody id="editorTable">
                        <tr><td colspan="3" style="text-align:center"><span class="loader"></span></td></tr>
                    </tbody>
                </table>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="card" style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; font-weight: 800; color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);" id="totalClicks">0</div>
                    <div style="text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-top: 10px;">Всього кліків</div>
                </div>

                <div class="card">
                    <h2><i data-feather="link"></i> Скорочувач</h2>
                    <div class="shortener-box">
                        <input type="text" id="urlInput" placeholder="https://..." style="flex:1;">
                        <button onclick="shortenLink()" class="btn btn-primary" style="width: auto;">✂️</button>
                    </div>
                    <div id="shortResult" style="margin-top: 15px; display: none;">
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="shortUrlText" style="color: #a5f3fc; font-family: monospace;"></span>
                            <button onclick="copyLink()" class="btn" style="width:auto; padding: 5px 10px; font-size: 0.8em;">Copy</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { backendUrl } from './api.js';

        feather.replace();

        async function loadAnalytics() {
            try {
                const res = await fetch(`${backendUrl}/api/analytics/dashboard`);
                const data = await res.json();
                
                renderHeatmap(data.heatmap_data);
                renderEditors(data.editor_stats);
                animateNumber('totalClicks', data.total_clicks);

            } catch (e) {
                console.error(e);
            }
        }

        // --- RENDER HEATMAP ---
        function renderHeatmap(data) {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            
            // Map data to dictionary: "2025-01-01" -> 5
            const counts = {};
            let maxCount = 0;
            data.forEach(d => {
                counts[d.post_date] = d.count;
                if(d.count > maxCount) maxCount = d.count;
            });

            // Generate last 365 days
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);

            // GitHub logic: columns are weeks, rows are days (Sun-Sat)
            // But simple CSS grid: just fill cells. 
            // Better: 52 columns, 7 rows.
            
            for (let i = 0; i < 365; i++) {
                // Calculate date for this cell (going backwards or forwards? usually left-to-right is past-to-future)
                // Let's simplified: 365 div elements.
                // NOTE: Real calendar alignment is hard in vanilla JS without libraries.
                // We will just render last 52 weeks * 7 days = 364 cells.
                
                const d = new Date(oneYearAgo);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const count = counts[dateStr] || 0;
                
                // Determine level
                let level = 0;
                if (count > 0) {
                    const pct = count / (maxCount || 1);
                    if (pct < 0.25) level = 1;
                    else if (pct < 0.5) level = 2;
                    else if (pct < 0.75) level = 3;
                    else level = 4;
                }

                const cell = document.createElement('div');
                cell.className = `day-cell lvl-${level}`;
                cell.title = `${dateStr}: ${count} постів`;
                container.appendChild(cell);
            }
        }

        // --- RENDER EDITORS ---
        function renderEditors(editors) {
            const tbody = document.getElementById('editorTable');
            tbody.innerHTML = '';
            
            if(editors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Дані відсутні</td></tr>';
                return;
            }

            // Find max for progress bar
            const maxPosts = Math.max(...editors.map(e => e.total_posts));

            editors.forEach(e => {
                const percent = (e.total_posts / maxPosts) * 100;
                const lastSeen = e.last_active ? new Date(e.last_active).toLocaleDateString() : '-';
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:bold; color:white;">${e.username}</div>
                            <div style="font-size:0.8em; opacity:0.6;">Останній: ${lastSeen}</div>
                        </td>
                        <td style="font-weight:800; font-size:1.1em;">${e.total_posts}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${percent}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- UTILS ---
        function animateNumber(id, target) {
            const el = document.getElementById(id);
            let current = 0;
            const step = Math.ceil(target / 50);
            const timer = setInterval(() => {
                current += step;
                if(current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                el.innerText = current;
            }, 20);
        }

        // --- LINK SHORTENER ---
        window.shortenLink = async () => {
            const url = document.getElementById('urlInput').value;
            if(!url) return;
            
            try {
                const res = await fetch(`${backendUrl}/api/links/shorten`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if(data.short_url) {
                    document.getElementById('shortResult').style.display = 'block';
                    document.getElementById('shortUrlText').innerText = data.short_url;
                }
            } catch(e) { alert('Error'); }
        };

        window.copyLink = () => {
            const text = document.getElementById('shortUrlText').innerText;
            navigator.clipboard.writeText(text);
            alert('Скопійовано!');
        }

        loadAnalytics();
    </script>
    <script src="nav-loader.js"></script>
    <script src="garland.js" type="module"></script>
</body>
</html>
