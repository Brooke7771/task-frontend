<!DOCTYPE html>
<html lang="uk" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∫–ª–∞–º–Ω—ñ –ö–∞–º–ø–∞–Ω—ñ—ó</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="auth-guard.js"></script>
    <style>
        /* --- Cosmic Theme Styles --- */
        body {
            background-color: #020617;
            min-height: 100vh;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* Background Effects */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none; z-index: -1;
        }
        .bg-orb {
            position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.3; z-index: -2;
            animation: floatOrb 15s ease-in-out infinite alternate;
        }
        .orb-1 { width: 600px; height: 600px; background: #f59e0b; top: -200px; left: -100px; } /* Amber */
        .orb-2 { width: 500px; height: 500px; background: #ec4899; bottom: -150px; right: -150px; animation-delay: -5s; } /* Pink */
        .orb-3 { width: 300px; height: 300px; background: #8b5cf6; top: 40%; left: 30%; opacity: 0.15; animation-delay: -8s; } /* Purple */
        
        @keyframes floatOrb { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 40px); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Glass Containers */
        .container-main { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        .card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        h1, h2 {
            font-weight: 800; letter-spacing: -0.5px; margin-bottom: 20px;
            background: linear-gradient(135deg, #fff, #94a3b8);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        h2 { font-size: 1.5rem; margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }

        /* Form Styling */
        label { 
            color: #94a3b8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; 
        }
        
        input, select, textarea {
            background: rgba(0, 0, 0, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            border-radius: 12px !important;
            padding: 12px 15px !important;
            font-size: 1rem !important;
            transition: 0.3s !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.2) !important;
            background: rgba(0, 0, 0, 0.4) !important;
            outline: none;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            border: none; padding: 14px 25px; font-weight: 700; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(var(--color-primary-rgb), 0.4);
            width: 100%; margin-top: 10px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--color-primary-rgb), 0.5); }

        /* Ads List Items */
        #adsList { display: grid; gap: 15px; }
        
        .ad-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px; padding: 20px;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .ad-item:hover { background: rgba(255, 255, 255, 0.05); transform: translateY(-3px); border-color: rgba(255,255,255,0.1); }
        
        .ad-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .ad-id { font-family: monospace; color: #64748b; font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        .ad-status { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; }
        .status-active { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-ended { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

        .ad-text { color: #cbd5e1; font-size: 0.95rem; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .ad-stats {
            display: flex; gap: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; margin-top: 12px;
        }
        .stat-badge { font-size: 0.85rem; color: #94a3b8; display: flex; align-items: center; gap: 6px; }
        
        .delete-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.05); color: #ef4444; border: none;
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); color: #f87171; }
    </style>
</head>
<body>

    <div class="noise-overlay"></div>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>

    <div class="container-main">
        <div class="card">
            <h1>üì¢ –ú–µ–Ω–µ–¥–∂–µ—Ä –†–µ–∫–ª–∞–º–∏</h1>
            <p style="color: var(--color-text-light); margin-bottom: 25px; font-size: 0.95rem;">
                –°—Ç–≤–æ—Ä—ñ—Ç—å –∫–∞–º–ø–∞–Ω—ñ—é, —ñ –±–æ—Ç –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —ó—ó —ñ–∑ –∑–∞–¥–∞–Ω–∏–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º.
            </p>
            
            <form id="adForm">
                <div class="form-group">
                    <label><i data-feather="radio" style="width:14px; vertical-align:middle;"></i> –ö–∞–Ω–∞–ª</label>
                    <select id="channel_select" name="target_channel_id" required>
                        <option value="" disabled selected>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i data-feather="file-text" style="width:14px; vertical-align:middle;"></i> –¢–µ–∫—Å—Ç –ø–æ—Å—Ç—É (Markdown/HTML)</label>
                    <textarea id="post_text" name="post_text" rows="4" required placeholder="üî• –ì–∞—Ä—è—á–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è! –¢—ñ–ª—å–∫–∏ —Å—å–æ–≥–æ–¥–Ω—ñ..."></textarea>
                </div>
                
                <div class="form-group">
                    <label><i data-feather="image" style="width:14px; vertical-align:middle;"></i> –ú–µ–¥—ñ–∞ (–§–æ—Ç–æ/–í—ñ–¥–µ–æ)</label>
                    <div style="position: relative;">
                        <input type="file" id="post_photo" name="post_photo" multiple style="padding-left: 40px !important;">
                        <i data-feather="upload" style="position: absolute; left: 12px; top: 12px; color: var(--color-text-light); width: 18px;"></i>
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex:1; min-width: 150px;">
                        <label><i data-feather="clock" style="width:14px; vertical-align:middle;"></i> –Ü–Ω—Ç–µ—Ä–≤–∞–ª (—Ö–≤)</label>
                        <input type="number" name="interval" value="60" min="1" required>
                    </div>
                    <div class="form-group" style="flex:1; min-width: 150px;">
                        <label><i data-feather="repeat" style="width:14px; vertical-align:middle;"></i> –ü–æ–≤—Ç–æ—Ä—ñ–≤</label>
                        <input type="number" name="count" value="5" min="1" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">
                    <i data-feather="play" style="vertical-align: middle; margin-right: 5px;"></i> –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–ø–∞–Ω—ñ—é
                </button>
            </form>
        </div>

        <div class="card" style="margin-top: 40px; animation-delay: 0.2s;">
            <h2>–ê–∫—Ç–∏–≤–Ω—ñ –∫–∞–º–ø–∞–Ω—ñ—ó</h2>
            <div id="adsList">
                <div style="text-align: center; color: var(--color-text-light); padding: 20px;">
                    <span class="loader"></span> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getChannels, backendUrl } from './api.js';

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–∫–æ–Ω–æ–∫
        feather.replace();

        document.addEventListener('DOMContentLoaded', async () => {
            const channelSelect = document.getElementById('channel_select');
            const form = document.getElementById('adForm');
            const adsList = document.getElementById('adsList');

            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–Ω–∞–ª—ñ–≤
            try {
                const channels = await getChannels();
                channelSelect.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–∞–Ω–∞–ª...</option>';
                
                if (channels && channels.length > 0) {
                    channels.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.telegram_id;
                        opt.textContent = c.title;
                        channelSelect.appendChild(opt);
                    });
                } else {
                    channelSelect.innerHTML = '<option value="" disabled>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞–Ω–∞–ª—ñ–≤</option>';
                }
            } catch (e) {
                console.error("Error loading channels", e);
                channelSelect.innerHTML = '<option disabled>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>';
            }
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ä–µ–∫–ª–∞–º
            const loadAds = async () => {
                try {
                    const res = await fetch(`${backendUrl}/api/ads`);
                    const ads = await res.json();
                    
                    if (ads.length === 0) {
                        adsList.innerHTML = '<div style="text-align: center; color: var(--color-text-light); padding: 20px;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–∞–º–ø–∞–Ω—ñ–π</div>';
                        return;
                    }

                    adsList.innerHTML = ads.map(ad => `
                        <div class="ad-item">
                            <div class="ad-header">
                                <span class="ad-id">#${ad.id.substring(0,8)}</span>
                                <span class="ad-status ${ad.active ? 'status-active' : 'status-ended'}">
                                    ${ad.active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'}
                                </span>
                            </div>
                            
                            <div class="ad-text">${ad.text.replace(/<[^>]*>?/gm, '')}</div>
                            
                            <div class="ad-stats">
                                <span class="stat-badge"><i data-feather="clock" style="width:14px"></i> ${ad.interval_minutes} —Ö–≤</span>
                                <span class="stat-badge"><i data-feather="hash" style="width:14px"></i> –ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${ad.remaining_count}</span>
                            </div>

                            <button onclick="deleteAd('${ad.id}')" class="delete-btn" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                <i data-feather="trash-2" style="width:16px"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    feather.replace(); // –û–Ω–æ–≤–∏—Ç–∏ —ñ–∫–æ–Ω–∫–∏ –≤ –Ω–æ–≤–æ–º—É HTML
                } catch (e) {
                    adsList.innerHTML = '<div style="color: #f87171; text-align:center;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É</div>';
                }
            };
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
            window.deleteAd = async (id) => {
                if(!confirm('–ó—É–ø–∏–Ω–∏—Ç–∏ —Ç–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∫–∞–º–ø–∞–Ω—ñ—é?')) return;
                try {
                    await fetch(`${backendUrl}/api/ads/${id}/delete`, { method: 'POST' });
                    loadAds();
                } catch(e) { alert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è"); }
            };

            loadAds();

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∫–ª–∞–º–∏
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è...';
                btn.disabled = true;

                const formData = new FormData(form);
                
                try {
                    const res = await fetch(`${backendUrl}/api/ads`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Username': localStorage.getItem('username') || 'Unknown'
                        }
                    });

                    if(res.ok) {
                        alert('–ö–∞–º–ø–∞–Ω—ñ—é —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ! üöÄ');
                        form.reset();
                        loadAds();
                    } else {
                        alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è');
                    }
                } catch (e) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    </script>

    <!-- FAB Menu (–ì–ª–æ–±–∞–ª—å–Ω–µ) -->
    <div class="fab-container">
        <div class="fab-options">
            <a href="#" onclick="logout(); return false;" class="fab-option" style="color: var(--color-danger);">
                <i data-feather="log-out"></i><span>–í–∏–π—Ç–∏</span>
            </a>
            <a href="index.html" class="fab-option"><i data-feather="plus-circle"></i><span>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ó–∞–≤–¥–∞–Ω–Ω—è</span></a>
            <a href="task-list.html" class="fab-option"><i data-feather="list"></i><span>–°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</span></a>
            <a href="schedule.html" class="fab-option"><i data-feather="calendar"></i><span>–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –ü–æ—Å—Ç</span></a>
            <a href="schedule-list.html" class="fab-option"><i data-feather="clock"></i><span>–°–ø–∏—Å–æ–∫ –ü–æ—Å—Ç—ñ–≤</span></a>
            <a href="ads.html" class="fab-option active"><i data-feather="megaphone"></i><span>–†–µ–∫–ª–∞–º–∞</span></a>
            <a href="history.html" class="fab-option"><i data-feather="archive"></i><span>–Ü—Å—Ç–æ—Ä—ñ—è</span></a>
            <a href="chat.html" class="fab-option"><i data-feather="message-circle"></i><span>AI –ß–∞—Ç</span></a>
            <a href="settings.html" class="fab-option"><i data-feather="settings"></i><span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></a>
            <a href="admin.html" class="fab-option"><i data-feather="settings"></i><span>ADMIN</span></a>
        </div>
        <button class="fab-main" id="fab-toggle">
            <i class="fab-main-icon fab-icon-menu" data-feather="menu"></i>
            <i class="fab-main-icon fab-icon-close" data-feather="x"></i>
        </button>
    </div>

    <script>
        // --- FAB Logic ---
        const fabContainer = document.querySelector('.fab-container');
        let idleTimer;
        const setIdle = () => { if (fabContainer && !fabContainer.classList.contains('active')) fabContainer.classList.add('is-idle'); };
        const resetIdleTimer = () => { clearTimeout(idleTimer); if (fabContainer) fabContainer.classList.remove('is-idle'); idleTimer = setTimeout(setIdle, 4000); };
        resetIdleTimer();
        ['scroll', 'touchstart', 'click', 'keypress'].forEach(event => document.addEventListener(event, resetIdleTimer));
        
        document.getElementById('fab-toggle').addEventListener('click', (e) => {
            e.stopPropagation(); fabContainer.classList.toggle('active');
            if (fabContainer.classList.contains('active')) { fabContainer.classList.remove('is-idle'); clearTimeout(idleTimer); } else { resetIdleTimer(); }
        });
        document.addEventListener('click', (e) => {
            if (fabContainer && fabContainer.classList.contains('active') && !fabContainer.contains(e.target)) { fabContainer.classList.remove('active'); resetIdleTimer(); }
        });
    </script>
</body>
</html>